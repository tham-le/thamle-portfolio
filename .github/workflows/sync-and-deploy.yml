name: Sync, Build, and Deploy Portfolio

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
  schedule:
    # Weekly sync on Monday at 6 AM UTC
    - cron: '0 6 * * 1'

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  sync-build-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        token: ${{ secrets.TOKEN_GITHUB }}
        fetch-depth: 0  # Needed for change detection

    - name: Detect changes
      uses: dorny/paths-filter@v3
      id: changes
      if: github.event_name == 'push'
      with:
        filters: |
          portfolio:
            - 'content/**'
            - 'layouts/**'
            - 'themes/**'
            - 'assets/**'
            - 'config/**'
            - 'scripts/**'
            - 'hugo.toml'
            - '.github/workflows/sync-and-deploy.yml'
          notes:
            - 'static/notes/**'

    - name: Set deployment flags for manual/scheduled runs
      id: deploy_flags
      run: |
        # For manual or scheduled runs, deploy everything
        if [[ "${{ github.event_name }}" == "workflow_dispatch" || "${{ github.event_name }}" == "schedule" ]]; then
          echo "portfolio=true" >> $GITHUB_OUTPUT
          echo "notes=true" >> $GITHUB_OUTPUT
          echo "reason=manual_or_scheduled" >> $GITHUB_OUTPUT
        else
          # For push events, use change detection
          echo "portfolio=${{ steps.changes.outputs.portfolio }}" >> $GITHUB_OUTPUT
          echo "notes=${{ steps.changes.outputs.notes }}" >> $GITHUB_OUTPUT
          echo "reason=change_detection" >> $GITHUB_OUTPUT
        fi

    - name: Show deployment plan
      run: |
        echo "üîç Deployment Plan:"
        echo "  Trigger: ${{ github.event_name }}"
        echo "  Reason: ${{ steps.deploy_flags.outputs.reason }}"
        echo "  Portfolio deployment: ${{ steps.deploy_flags.outputs.portfolio }}"
        echo "  Notes deployment: ${{ steps.deploy_flags.outputs.notes }}"
        echo ""
        if [[ "${{ steps.deploy_flags.outputs.portfolio }}" == "true" ]]; then
          echo "‚úÖ Will deploy thamle.live (portfolio)"
        else
          echo "‚è≠Ô∏è  Skipping thamle.live (no changes)"
        fi
        if [[ "${{ steps.deploy_flags.outputs.notes }}" == "true" ]]; then
          echo "‚úÖ Will deploy notes.thamle.live"
        else
          echo "‚è≠Ô∏è  Skipping notes.thamle.live (no changes)"
        fi
        if [[ "${{ steps.deploy_flags.outputs.portfolio }}" != "true" && "${{ steps.deploy_flags.outputs.notes }}" != "true" ]]; then
          echo "‚ÑπÔ∏è  No deployments needed"
        fi

    - name: Setup environment
      if: steps.deploy_flags.outputs.portfolio == 'true'
      run: |
        echo "GITHUB_TOKEN=${{ secrets.TOKEN_GITHUB }}" >> .env
        echo "GITHUB_USERNAME=tham-le" >> .env
        echo "HUGO_ENV=production" >> .env

    - name: Cache apt packages
      if: steps.deploy_flags.outputs.portfolio == 'true'
      uses: actions/cache@v4
      with:
        path: /var/cache/apt
        key: ${{ runner.os }}-apt-${{ hashFiles('**/sync-all.sh') }}
        restore-keys: |
          ${{ runner.os }}-apt-

    - name: Install dependencies
      if: steps.deploy_flags.outputs.portfolio == 'true'
      run: |
        sudo apt-get update
        sudo apt-get install -y jq curl

    - name: Sync all content
      if: steps.deploy_flags.outputs.portfolio == 'true'
      run: |
        chmod +x ./scripts/sync-all.sh
        ./scripts/sync-all.sh
      env:
        GITHUB_TOKEN: ${{ secrets.TOKEN_GITHUB }}

    - name: Generate CTF index files
      if: steps.deploy_flags.outputs.portfolio == 'true'
      run: |
        echo "üîß Generating CTF _index.md files..."
        chmod +x ./scripts/generate-ctf-indexes.sh
        bash ./scripts/generate-ctf-indexes.sh
        echo "‚úÖ CTF index files generated!"

    - name: Cache Hugo resources
      if: steps.deploy_flags.outputs.portfolio == 'true'
      uses: actions/cache@v4
      with:
        path: |
          resources
          .hugo_build.lock
        key: ${{ runner.os }}-hugo-${{ hashFiles('**/hugo.toml') }}
        restore-keys: |
          ${{ runner.os }}-hugo-

    - name: Setup Hugo
      if: steps.deploy_flags.outputs.portfolio == 'true'
      uses: peaceiris/actions-hugo@v3
      with:
        hugo-version: '0.129.0'
        extended: true

    - name: Test Hugo build
      if: steps.deploy_flags.outputs.portfolio == 'true'
      run: |
        echo "üîç Testing Hugo build..."
        hugo --minify --environment production
        echo "‚úÖ Hugo build successful!"

    - name: Verify build output
      if: steps.deploy_flags.outputs.portfolio == 'true'
      run: |
        echo "üîç Verifying build output..."
        if [ ! -d "public" ]; then
          echo "‚ùå Public directory not created"
          exit 1
        fi

        if [ ! -f "public/index.html" ]; then
          echo "‚ùå Index.html not generated"
          exit 1
        fi

        echo "‚úÖ Build verification successful!"
        echo "üìä Build statistics:"
        echo "- Total files: $(find public -type f | wc -l)"
        echo "- HTML files: $(find public -name "*.html" | wc -l)"
        echo "- CSS files: $(find public -name "*.css" | wc -l)"
        echo "- JS files: $(find public -name "*.js" | wc -l)"

    - name: Verify notes content
      if: steps.deploy_flags.outputs.notes == 'true'
      run: |
        echo "üîç Verifying notes content..."
        if [ ! -d "static/notes" ]; then
          echo "‚ùå Notes directory not found"
          exit 1
        fi

        NOTES_COUNT=$(find static/notes -name "*.html" | wc -l)
        echo "‚úÖ Found $NOTES_COUNT HTML files in notes directory"

        if [ $NOTES_COUNT -lt 50 ]; then
          echo "‚ö†Ô∏è  Warning: Expected more HTML files in notes"
        fi

    - name: Deploy Portfolio to Firebase
      if: steps.deploy_flags.outputs.portfolio == 'true'
      uses: FirebaseExtended/action-hosting-deploy@v0
      with:
        repoToken: '${{ secrets.GITHUB_TOKEN }}'
        firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_THAMLE_PORTFOLIO }}'
        projectId: '${{ secrets.FIREBASE_PROJECT_ID }}'
        channelId: live
        target: thamle-portfolio

    - name: Deploy Notes to Subdomain
      if: steps.deploy_flags.outputs.notes == 'true'
      uses: FirebaseExtended/action-hosting-deploy@v0
      with:
        repoToken: '${{ secrets.GITHUB_TOKEN }}'
        firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_THAMLE_PORTFOLIO }}'
        projectId: '${{ secrets.FIREBASE_PROJECT_ID }}'
        channelId: live
        target: notes-tham
