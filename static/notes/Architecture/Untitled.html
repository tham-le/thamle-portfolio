<!DOCTYPE html>
<html lang="en" dir="ltr"><head><title>Untitled</title><meta charset="utf-8"/><link rel="preconnect" href="https://fonts.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com"/><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Schibsted Grotesk:wght@400;700&amp;family=Source Sans Pro:ital,wght@0,400;0,600;1,400;1,600&amp;family=IBM Plex Mono:wght@400;600&amp;display=swap"/><link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin="anonymous"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="og:site_name" content="Tham Le's Notes"/><meta property="og:title" content="Untitled"/><meta property="og:type" content="website"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:title" content="Untitled"/><meta name="twitter:description" content="Here are the requested articles for Phase 5 (Windows Intermediate Layer) and Phase 6 (Comparison &amp; Advanced), structured as separate Markdown files."/><meta property="og:description" content="Here are the requested articles for Phase 5 (Windows Intermediate Layer) and Phase 6 (Comparison &amp; Advanced), structured as separate Markdown files."/><meta property="og:image:alt" content="Here are the requested articles for Phase 5 (Windows Intermediate Layer) and Phase 6 (Comparison &amp; Advanced), structured as separate Markdown files."/><meta property="og:image" content="https://notes.thamle.live/static/og-image.png"/><meta property="og:image:url" content="https://notes.thamle.live/static/og-image.png"/><meta name="twitter:image" content="https://notes.thamle.live/static/og-image.png"/><meta property="og:image:type" content="image/.png"/><meta property="twitter:domain" content="notes.thamle.live"/><meta property="og:url" content="https://notes.thamle.live/Architecture/Untitled"/><meta property="twitter:url" content="https://notes.thamle.live/Architecture/Untitled"/><link rel="icon" href="../static/icon.png"/><meta name="description" content="Here are the requested articles for Phase 5 (Windows Intermediate Layer) and Phase 6 (Comparison &amp; Advanced), structured as separate Markdown files."/><meta name="generator" content="Quartz"/><link href="../index.css" rel="stylesheet" type="text/css" spa-preserve/><style>.expand-button {
  position: absolute;
  display: flex;
  float: right;
  padding: 0.4rem;
  margin: 0.3rem;
  right: 0;
  color: var(--gray);
  border-color: var(--dark);
  background-color: var(--light);
  border: 1px solid;
  border-radius: 5px;
  opacity: 0;
  transition: 0.2s;
}
.expand-button > svg {
  fill: var(--light);
  filter: contrast(0.3);
}
.expand-button:hover {
  cursor: pointer;
  border-color: var(--secondary);
}
.expand-button:focus {
  outline: 0;
}

pre:hover > .expand-button {
  opacity: 1;
  transition: 0.2s;
}

#mermaid-container {
  position: fixed;
  contain: layout;
  z-index: 999;
  left: 0;
  top: 0;
  width: 100vw;
  height: 100vh;
  overflow: hidden;
  display: none;
  backdrop-filter: blur(4px);
  background: rgba(0, 0, 0, 0.5);
}
#mermaid-container.active {
  display: inline-block;
}
#mermaid-container > #mermaid-space {
  border: 1px solid var(--lightgray);
  background-color: var(--light);
  border-radius: 5px;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  height: 80vh;
  width: 80vw;
  overflow: hidden;
}
#mermaid-container > #mermaid-space > .mermaid-content {
  padding: 2rem;
  position: relative;
  transform-origin: 0 0;
  transition: transform 0.1s ease;
  overflow: visible;
  min-height: 200px;
  min-width: 200px;
}
#mermaid-container > #mermaid-space > .mermaid-content pre {
  margin: 0;
  border: none;
}
#mermaid-container > #mermaid-space > .mermaid-content svg {
  max-width: none;
  height: auto;
}
#mermaid-container > #mermaid-space > .mermaid-controls {
  position: absolute;
  bottom: 20px;
  right: 20px;
  display: flex;
  gap: 8px;
  padding: 8px;
  background: var(--light);
  border: 1px solid var(--lightgray);
  border-radius: 6px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  z-index: 2;
}
#mermaid-container > #mermaid-space > .mermaid-controls .mermaid-control-button {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
  padding: 0;
  border: 1px solid var(--lightgray);
  background: var(--light);
  color: var(--dark);
  border-radius: 4px;
  cursor: pointer;
  font-size: 16px;
  font-family: var(--bodyFont);
  transition: all 0.2s ease;
}
#mermaid-container > #mermaid-space > .mermaid-controls .mermaid-control-button:hover {
  background: var(--lightgray);
}
#mermaid-container > #mermaid-space > .mermaid-controls .mermaid-control-button:active {
  transform: translateY(1px);
}
#mermaid-container > #mermaid-space > .mermaid-controls .mermaid-control-button:nth-child(2) {
  width: auto;
  padding: 0 12px;
  font-size: 14px;
}
/*# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VSb290IjoiL2hvbWUvcnVubmVyL3dvcmsvbXktbm90ZXMvbXktbm90ZXMvcXVhcnR6L2NvbXBvbmVudHMvc3R5bGVzIiwic291cmNlcyI6WyJtZXJtYWlkLmlubGluZS5zY3NzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0VBQ0U7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7O0FBRUE7RUFDRTtFQUNBOztBQUdGO0VBQ0U7RUFDQTs7QUFHRjtFQUNFOzs7QUFLRjtFQUNFO0VBQ0E7OztBQUlKO0VBQ0U7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTs7QUFFQTtFQUNFOztBQUdGO0VBQ0U7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7O0FBRUE7RUFDRTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTs7QUFFQTtFQUNFO0VBQ0E7O0FBR0Y7RUFDRTtFQUNBOztBQUlKO0VBQ0U7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTs7QUFFQTtFQUNFO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7O0FBRUE7RUFDRTs7QUFHRjtFQUNFOztBQUlGO0VBQ0U7RUFDQTtFQUNBIiwic291cmNlc0NvbnRlbnQiOlsiLmV4cGFuZC1idXR0b24ge1xuICBwb3NpdGlvbjogYWJzb2x1dGU7XG4gIGRpc3BsYXk6IGZsZXg7XG4gIGZsb2F0OiByaWdodDtcbiAgcGFkZGluZzogMC40cmVtO1xuICBtYXJnaW46IDAuM3JlbTtcbiAgcmlnaHQ6IDA7IC8vIE5PVEU6IHJpZ2h0IHdpbGwgYmUgc2V0IGluIG1lcm1haWQuaW5saW5lLnRzXG4gIGNvbG9yOiB2YXIoLS1ncmF5KTtcbiAgYm9yZGVyLWNvbG9yOiB2YXIoLS1kYXJrKTtcbiAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tbGlnaHQpO1xuICBib3JkZXI6IDFweCBzb2xpZDtcbiAgYm9yZGVyLXJhZGl1czogNXB4O1xuICBvcGFjaXR5OiAwO1xuICB0cmFuc2l0aW9uOiAwLjJzO1xuXG4gICYgPiBzdmcge1xuICAgIGZpbGw6IHZhcigtLWxpZ2h0KTtcbiAgICBmaWx0ZXI6IGNvbnRyYXN0KDAuMyk7XG4gIH1cblxuICAmOmhvdmVyIHtcbiAgICBjdXJzb3I6IHBvaW50ZXI7XG4gICAgYm9yZGVyLWNvbG9yOiB2YXIoLS1zZWNvbmRhcnkpO1xuICB9XG5cbiAgJjpmb2N1cyB7XG4gICAgb3V0bGluZTogMDtcbiAgfVxufVxuXG5wcmUge1xuICAmOmhvdmVyID4gLmV4cGFuZC1idXR0b24ge1xuICAgIG9wYWNpdHk6IDE7XG4gICAgdHJhbnNpdGlvbjogMC4ycztcbiAgfVxufVxuXG4jbWVybWFpZC1jb250YWluZXIge1xuICBwb3NpdGlvbjogZml4ZWQ7XG4gIGNvbnRhaW46IGxheW91dDtcbiAgei1pbmRleDogOTk5O1xuICBsZWZ0OiAwO1xuICB0b3A6IDA7XG4gIHdpZHRoOiAxMDB2dztcbiAgaGVpZ2h0OiAxMDB2aDtcbiAgb3ZlcmZsb3c6IGhpZGRlbjtcbiAgZGlzcGxheTogbm9uZTtcbiAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDRweCk7XG4gIGJhY2tncm91bmQ6IHJnYmEoMCwgMCwgMCwgMC41KTtcblxuICAmLmFjdGl2ZSB7XG4gICAgZGlzcGxheTogaW5saW5lLWJsb2NrO1xuICB9XG5cbiAgJiA+ICNtZXJtYWlkLXNwYWNlIHtcbiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1saWdodGdyYXkpO1xuICAgIGJhY2tncm91bmQtY29sb3I6IHZhcigtLWxpZ2h0KTtcbiAgICBib3JkZXItcmFkaXVzOiA1cHg7XG4gICAgcG9zaXRpb246IGZpeGVkO1xuICAgIHRvcDogNTAlO1xuICAgIGxlZnQ6IDUwJTtcbiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTtcbiAgICBoZWlnaHQ6IDgwdmg7XG4gICAgd2lkdGg6IDgwdnc7XG4gICAgb3ZlcmZsb3c6IGhpZGRlbjtcblxuICAgICYgPiAubWVybWFpZC1jb250ZW50IHtcbiAgICAgIHBhZGRpbmc6IDJyZW07XG4gICAgICBwb3NpdGlvbjogcmVsYXRpdmU7XG4gICAgICB0cmFuc2Zvcm0tb3JpZ2luOiAwIDA7XG4gICAgICB0cmFuc2l0aW9uOiB0cmFuc2Zvcm0gMC4xcyBlYXNlO1xuICAgICAgb3ZlcmZsb3c6IHZpc2libGU7XG4gICAgICBtaW4taGVpZ2h0OiAyMDBweDtcbiAgICAgIG1pbi13aWR0aDogMjAwcHg7XG5cbiAgICAgIHByZSB7XG4gICAgICAgIG1hcmdpbjogMDtcbiAgICAgICAgYm9yZGVyOiBub25lO1xuICAgICAgfVxuXG4gICAgICBzdmcge1xuICAgICAgICBtYXgtd2lkdGg6IG5vbmU7XG4gICAgICAgIGhlaWdodDogYXV0bztcbiAgICAgIH1cbiAgICB9XG5cbiAgICAmID4gLm1lcm1haWQtY29udHJvbHMge1xuICAgICAgcG9zaXRpb246IGFic29sdXRlO1xuICAgICAgYm90dG9tOiAyMHB4O1xuICAgICAgcmlnaHQ6IDIwcHg7XG4gICAgICBkaXNwbGF5OiBmbGV4O1xuICAgICAgZ2FwOiA4cHg7XG4gICAgICBwYWRkaW5nOiA4cHg7XG4gICAgICBiYWNrZ3JvdW5kOiB2YXIoLS1saWdodCk7XG4gICAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1saWdodGdyYXkpO1xuICAgICAgYm9yZGVyLXJhZGl1czogNnB4O1xuICAgICAgYm94LXNoYWRvdzogMCAycHggNHB4IHJnYmEoMCwgMCwgMCwgMC4xKTtcbiAgICAgIHotaW5kZXg6IDI7XG5cbiAgICAgIC5tZXJtYWlkLWNvbnRyb2wtYnV0dG9uIHtcbiAgICAgICAgZGlzcGxheTogZmxleDtcbiAgICAgICAgYWxpZ24taXRlbXM6IGNlbnRlcjtcbiAgICAgICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7XG4gICAgICAgIHdpZHRoOiAzMnB4O1xuICAgICAgICBoZWlnaHQ6IDMycHg7XG4gICAgICAgIHBhZGRpbmc6IDA7XG4gICAgICAgIGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWxpZ2h0Z3JheSk7XG4gICAgICAgIGJhY2tncm91bmQ6IHZhcigtLWxpZ2h0KTtcbiAgICAgICAgY29sb3I6IHZhcigtLWRhcmspO1xuICAgICAgICBib3JkZXItcmFkaXVzOiA0cHg7XG4gICAgICAgIGN1cnNvcjogcG9pbnRlcjtcbiAgICAgICAgZm9udC1zaXplOiAxNnB4O1xuICAgICAgICBmb250LWZhbWlseTogdmFyKC0tYm9keUZvbnQpO1xuICAgICAgICB0cmFuc2l0aW9uOiBhbGwgMC4ycyBlYXNlO1xuXG4gICAgICAgICY6aG92ZXIge1xuICAgICAgICAgIGJhY2tncm91bmQ6IHZhcigtLWxpZ2h0Z3JheSk7XG4gICAgICAgIH1cblxuICAgICAgICAmOmFjdGl2ZSB7XG4gICAgICAgICAgdHJhbnNmb3JtOiB0cmFuc2xhdGVZKDFweCk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBTdHlsZSB0aGUgcmVzZXQgYnV0dG9uIGRpZmZlcmVudGx5XG4gICAgICAgICY6bnRoLWNoaWxkKDIpIHtcbiAgICAgICAgICB3aWR0aDogYXV0bztcbiAgICAgICAgICBwYWRkaW5nOiAwIDEycHg7XG4gICAgICAgICAgZm9udC1zaXplOiAxNHB4O1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG59XG4iXX0= */</style><link href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" rel="stylesheet" type="text/css" spa-preserve/><script src="../prescript.js" type="application/javascript" spa-preserve></script><script type="application/javascript" spa-preserve>const fetchData = fetch("../static/contentIndex.json").then(data => data.json())</script><link rel="alternate" type="application/rss+xml" title="RSS Feed" href="https://notes.thamle.live/index.xml"/></head><body data-slug="Architecture/Untitled"><div id="quartz-root" class="page"><div id="quartz-body"><div class="left sidebar"><h2 class="page-title"><a href="..">Tham Le's Notes</a></h2><div class="spacer mobile-only"></div><div class="search"><button class="search-button"><svg role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title>Search</title><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"></path><circle cx="8" cy="8" r="7"></circle></g></svg><p>Search</p></button><div class="search-container"><div class="search-space"><input autocomplete="off" class="search-bar" name="search" type="text" aria-label="Search for something" placeholder="Search for something"/><div class="search-layout" data-preview="true"></div></div></div></div><button class="darkmode"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" class="dayIcon" x="0px" y="0px" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35" xml:space="preserve" aria-label="Dark mode"><title>Dark mode</title><path d="M6,17.5C6,16.672,5.328,16,4.5,16h-3C0.672,16,0,16.672,0,17.5    S0.672,19,1.5,19h3C5.328,19,6,18.328,6,17.5z M7.5,26c-0.414,0-0.789,0.168-1.061,0.439l-2,2C4.168,28.711,4,29.086,4,29.5    C4,30.328,4.671,31,5.5,31c0.414,0,0.789-0.168,1.06-0.44l2-2C8.832,28.289,9,27.914,9,27.5C9,26.672,8.329,26,7.5,26z M17.5,6    C18.329,6,19,5.328,19,4.5v-3C19,0.672,18.329,0,17.5,0S16,0.672,16,1.5v3C16,5.328,16.671,6,17.5,6z M27.5,9    c0.414,0,0.789-0.168,1.06-0.439l2-2C30.832,6.289,31,5.914,31,5.5C31,4.672,30.329,4,29.5,4c-0.414,0-0.789,0.168-1.061,0.44    l-2,2C26.168,6.711,26,7.086,26,7.5C26,8.328,26.671,9,27.5,9z M6.439,8.561C6.711,8.832,7.086,9,7.5,9C8.328,9,9,8.328,9,7.5    c0-0.414-0.168-0.789-0.439-1.061l-2-2C6.289,4.168,5.914,4,5.5,4C4.672,4,4,4.672,4,5.5c0,0.414,0.168,0.789,0.439,1.06    L6.439,8.561z M33.5,16h-3c-0.828,0-1.5,0.672-1.5,1.5s0.672,1.5,1.5,1.5h3c0.828,0,1.5-0.672,1.5-1.5S34.328,16,33.5,16z     M28.561,26.439C28.289,26.168,27.914,26,27.5,26c-0.828,0-1.5,0.672-1.5,1.5c0,0.414,0.168,0.789,0.439,1.06l2,2    C28.711,30.832,29.086,31,29.5,31c0.828,0,1.5-0.672,1.5-1.5c0-0.414-0.168-0.789-0.439-1.061L28.561,26.439z M17.5,29    c-0.829,0-1.5,0.672-1.5,1.5v3c0,0.828,0.671,1.5,1.5,1.5s1.5-0.672,1.5-1.5v-3C19,29.672,18.329,29,17.5,29z M17.5,7    C11.71,7,7,11.71,7,17.5S11.71,28,17.5,28S28,23.29,28,17.5S23.29,7,17.5,7z M17.5,25c-4.136,0-7.5-3.364-7.5-7.5    c0-4.136,3.364-7.5,7.5-7.5c4.136,0,7.5,3.364,7.5,7.5C25,21.636,21.636,25,17.5,25z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" class="nightIcon" x="0px" y="0px" viewBox="0 0 100 100" style="enable-background:new 0 0 100 100" xml:space="preserve" aria-label="Light mode"><title>Light mode</title><path d="M96.76,66.458c-0.853-0.852-2.15-1.064-3.23-0.534c-6.063,2.991-12.858,4.571-19.655,4.571  C62.022,70.495,50.88,65.88,42.5,57.5C29.043,44.043,25.658,23.536,34.076,6.47c0.532-1.08,0.318-2.379-0.534-3.23  c-0.851-0.852-2.15-1.064-3.23-0.534c-4.918,2.427-9.375,5.619-13.246,9.491c-9.447,9.447-14.65,22.008-14.65,35.369  c0,13.36,5.203,25.921,14.65,35.368s22.008,14.65,35.368,14.65c13.361,0,25.921-5.203,35.369-14.65  c3.872-3.871,7.064-8.328,9.491-13.246C97.826,68.608,97.611,67.309,96.76,66.458z"></path></svg></button><div class="explorer desktop-only" data-behavior="link" data-collapsed="collapsed" data-savestate="true" data-data-fns="{&quot;order&quot;:[&quot;filter&quot;,&quot;map&quot;,&quot;sort&quot;],&quot;sortFn&quot;:&quot;(a,b)=>!a.isFolder&amp;&amp;!b.isFolder||a.isFolder&amp;&amp;b.isFolder?a.displayName.localeCompare(b.displayName,void 0,{numeric:!0,sensitivity:\&quot;base\&quot;}):!a.isFolder&amp;&amp;b.isFolder?1:-1&quot;,&quot;filterFn&quot;:&quot;node=>node.slugSegment!==\&quot;tags\&quot;&quot;,&quot;mapFn&quot;:&quot;node=>node&quot;}"><button type="button" class="explorer-toggle mobile-explorer hide-until-loaded" data-mobile="true" aria-controls="explorer-23"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide-menu"><line x1="4" x2="20" y1="12" y2="12"></line><line x1="4" x2="20" y1="6" y2="6"></line><line x1="4" x2="20" y1="18" y2="18"></line></svg></button><button type="button" class="title-button explorer-toggle desktop-explorer" data-mobile="false" aria-expanded="true"><h2>Explorer</h2><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="fold"><polyline points="6 9 12 15 18 9"></polyline></svg></button><div id="explorer-23" class="explorer-content" aria-expanded="false" role="group"><ul class="explorer-ul overflow" id="list-0"><li class="overflow-end"></li></ul></div><template id="template-file"><li><a href="#"></a></li></template><template id="template-folder"><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div><button class="folder-button"><span class="folder-title"></span></button></div></div><div class="folder-outer"><ul class="content"></ul></div></li></template></div></div><div class="center"><div class="page-header"><div class="popover-hint"><nav class="breadcrumb-container" aria-label="breadcrumbs"><div class="breadcrumb-element"><a href="../">Home</a><p> ❯ </p></div><div class="breadcrumb-element"><a href="../Architecture/">Architecture</a><p> ❯ </p></div><div class="breadcrumb-element"><a href>Untitled</a></div></nav><h1 class="article-title">Untitled</h1><p show-comma="true" class="content-meta"><time datetime="2025-12-11T17:47:18.143Z">Dec 11, 2025</time><span>22 min read</span></p></div></div><article class="popover-hint"><p>Here are the requested articles for <strong>Phase 5 (Windows Intermediate Layer)</strong> and <strong>Phase 6 (Comparison &amp; Advanced)</strong>, structured as separate Markdown files.</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="markdown" data-theme="github-light github-dark"><code data-language="markdown" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;--shiki-light-font-weight:bold;--shiki-dark-font-weight:bold;">---</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">title: &quot;WTF is HIDCLASS.SYS?&quot;</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">date: 2025-11-28</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">draft: false</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tags:</span></span>
<span data-line><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> windows</span></span>
<span data-line><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> drivers</span></span>
<span data-line><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> usb</span></span>
<span data-line><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> hid</span></span>
<span data-line><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> kernel</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">description: &quot;The universal translator that lets Windows understand any USB gadget without a custom driver.&quot;</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;--shiki-light-font-weight:bold;--shiki-dark-font-weight:bold;">---</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;--shiki-light-font-weight:bold;--shiki-dark-font-weight:bold;"># WTF is HIDCLASS.SYS?</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">*The middle-manager that saves us from driver hell.*</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">In the dark ages (Windows 95), if you bought a joystick, you installed a driver from a floppy disk. If you bought a mouse, floppy disk. Keypad? Floppy disk.</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Then came USB and the </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;--shiki-light-font-weight:bold;--shiki-dark-font-weight:bold;">**HID (Human Interface Device)**</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> standard. The promise was simple: &quot;Plug it in, and it just works.&quot;</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;--shiki-light-font-weight:bold;--shiki-dark-font-weight:bold;">**HIDCLASS.SYS**</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> is the hero delivering on that promise. It is a </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;--shiki-light-font-weight:bold;--shiki-dark-font-weight:bold;">**Class Driver**</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> provided by Microsoft that lives in the Windows Kernel. It knows how to talk to </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">*generic*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> USB things so manufacturers don't have to write kernel code for every single RGB mouse they sell.</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;--shiki-light-font-weight:bold;--shiki-dark-font-weight:bold;">## The Core Analogy</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Think of the Windows Driver stack like a </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;--shiki-light-font-weight:bold;--shiki-dark-font-weight:bold;">**Hospital**</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">1.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;--shiki-light-font-weight:bold;--shiki-dark-font-weight:bold;">  **The USB Bus Driver (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;--shiki-light-font-weight:bold;--shiki-dark-font-weight:bold;">`usbhub.sys`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;--shiki-light-font-weight:bold;--shiki-dark-font-weight:bold;">):**</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> The Ambulance Driver. It just delivers the patient (data packets) to the door. It doesn't know what's wrong with them.</span></span>
<span data-line><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">2.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;--shiki-light-font-weight:bold;--shiki-dark-font-weight:bold;">  **The Mini-Driver (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;--shiki-light-font-weight:bold;--shiki-dark-font-weight:bold;">`hidusb.sys`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;--shiki-light-font-weight:bold;--shiki-dark-font-weight:bold;">):**</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> The Triage Nurse. It says &quot;This is a USB patient, hand them over to the specialist.&quot;</span></span>
<span data-line><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">3.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;--shiki-light-font-weight:bold;--shiki-dark-font-weight:bold;">  **HIDCLASS.SYS:**</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> The </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;--shiki-light-font-weight:bold;--shiki-dark-font-weight:bold;">**General Practitioner**</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span></span>
<span data-line><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   It speaks the medical language (HID Reports).</span></span>
<span data-line><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   It examines the patient's chart (HID Report Descriptor).</span></span>
<span data-line><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   It translates &quot;Patient has elevated temp&quot; into a standard medical record &quot;Fever&quot; that the hospital system understands.</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Without HIDCLASS, every device would need its own specialized doctor.</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;--shiki-light-font-weight:bold;--shiki-dark-font-weight:bold;">## The Problem</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">USB devices send raw binary data.</span></span>
<span data-line><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   Mouse A sends: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">`0x01 0x05 0xFF`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (Button 1, X+5, Y-1).</span></span>
<span data-line><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   Mouse B sends: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">`0x05 0xFF 0x01`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (X+5, Y-1, Button 1).</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">If the OS had to hardcode every format, it would be impossible.</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Instead, the device sends a </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;--shiki-light-font-weight:bold;--shiki-dark-font-weight:bold;">**Report Descriptor**</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">—a metadata map that says: &quot;The first byte is the button, the second is X...&quot;</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;--shiki-light-font-weight:bold;--shiki-dark-font-weight:bold;">**HIDCLASS.SYS**</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> is the parser engine that reads this map and standardizes the data before the OS sees it.</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;--shiki-light-font-weight:bold;--shiki-dark-font-weight:bold;">## How It Works</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">HIDCLASS sits in the middle of the driver stack (between the FDO and PDO).</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">1.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;--shiki-light-font-weight:bold;--shiki-dark-font-weight:bold;">  **Enumeration:**</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> When you plug in a device, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">`hidusb.sys`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> loads and calls HIDCLASS.</span></span>
<span data-line><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">2.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;--shiki-light-font-weight:bold;--shiki-dark-font-weight:bold;">  **Parsing:**</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> HIDCLASS asks the device for its </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;--shiki-light-font-weight:bold;--shiki-dark-font-weight:bold;">**Report Descriptor**</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">. It parses this complex binary tree to understand what the device </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">*is*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (Mouse? Joystick? Thermometer?).</span></span>
<span data-line><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">3.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;--shiki-light-font-weight:bold;--shiki-dark-font-weight:bold;">  **The Hydration:**</span></span>
<span data-line><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;--shiki-light-font-weight:bold;--shiki-dark-font-weight:bold;">   **Inbound:**</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Raw USB packets come up. HIDCLASS unpacks them according to the descriptor and creates &quot;HID Collections.&quot;</span></span>
<span data-line><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;--shiki-light-font-weight:bold;--shiki-dark-font-weight:bold;">   **Outbound:**</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> The OS sends a command (Turn on LED). HIDCLASS packages it into the correct binary format for that specific hardware.</span></span>
<span data-line><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">4.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;--shiki-light-font-weight:bold;--shiki-dark-font-weight:bold;">  **Exposure:**</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> It creates the device interface (e.g., </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">`\\?\hid#vid_1234...`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) that User Mode apps talk to.</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;--shiki-light-font-weight:bold;--shiki-dark-font-weight:bold;">## Code Example: Talking to HIDCLASS</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">You don't talk to HIDCLASS directly via function calls; you send it </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;--shiki-light-font-weight:bold;--shiki-dark-font-weight:bold;">**IOCTLs**</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (I/O Control codes).</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Here is how you ask HIDCLASS for the device's attributes using the Win32 API:</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">```c</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &lt;windows.h></span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &lt;hidsdi.h></span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // You need the DDK/WDK for this</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &lt;setupapi.h></span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &lt;stdio.h></span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Link with hid.lib and setupapi.lib</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 1. Get a handle to the device (magic omitted for brevity)</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Assume hDevice is a valid handle opened with CreateFile</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    HANDLE hDevice </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> GetMyDeviceHandle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(); </span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (hDevice </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> INVALID_HANDLE_VALUE) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 2. Ask HIDCLASS for the attributes structure</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    HIDD_ATTRIBUTES attributes;</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    attributes.Size </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(attributes);</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">HidD_GetAttributes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(hDevice, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">attributes)) {</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        printf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Talking to HIDCLASS.SYS...</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        printf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Vendor ID:  0x</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%04X\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, attributes.VendorID);</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        printf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Product ID: 0x</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%04X\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, attributes.ProductID);</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        printf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Version:    0x</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%04X\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, attributes.VersionNumber);</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        printf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Failed to talk to HID driver.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 3. Get the Pre-parsed Data (The &quot;Map&quot;)</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    PHIDP_PREPARSED_DATA preparsedData;</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">HidD_GetPreparsedData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(hDevice, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">preparsedData)) {</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        HIDP_CAPS caps;</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        HidP_GetCaps</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(preparsedData, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">caps);</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        printf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Buttons: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, caps.NumberInputButtonCaps);</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        printf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Axes:    </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, caps.NumberInputValueCaps);</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        HidD_FreePreparsedData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(preparsedData);</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    CloseHandle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(hDevice);</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></figure>
<p><strong>What’s happening:</strong></p>
<ul>
<li><strong><code>HidD_GetAttributes</code></strong>: This isn’t a magic function. It internally creates an <strong>IRP</strong> (<code>IRP_MJ_DEVICE_CONTROL</code>) with code <code>IOCTL_HID_GET_ATTRIBUTES</code> and sends it down to the kernel.</li>
<li><strong>HIDCLASS.SYS</strong> catches that IRP, fills in the struct, and sends it back.</li>
</ul>
<h2 id="common-misconceptions">Common Misconceptions<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#common-misconceptions" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<blockquote class="callout warning" data-callout="warning">
<div class="callout-title">
                  <div class="callout-icon"></div>
                  <div class="callout-title-inner"><p>&quot;HID is only for Mice/Keyboards&quot; </p></div>
                  
                </div>
<div class="callout-content">
<p><strong>False.</strong> HID is used for UPS battery backups, medical devices, simulation cockpits, and even firmware updates. If you want to send data to a USB device without writing a custom driver, you make your device pretend to be HID.</p>
</div>
</blockquote>
<h2 id="whats-next">What’s Next<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#whats-next" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>HIDCLASS handles the translation. But how does that data actually move through the kernel? It travels in a yellow envelope called an <strong>IRP</strong>.</p>
<p>Next article: <strong>WTF is the Windows I/O Request Packet (IRP)?</strong></p>
<p><strong>Related:</strong></p>
<ul>
<li><a href="../WTF-is-the-Windows-Driver-Stack" class="internal alias" data-slug="WTF-is-the-Windows-Driver-Stack">WTF is the Windows Driver Stack?</a> - Where HIDCLASS lives.</li>
<li><a href="../Device-Drivers" class="internal alias" data-slug="Device-Drivers">Device Drivers</a> - The broader concept.</li>
<li><a href="../USB-Architecture" class="internal alias" data-slug="USB-Architecture">USB Architecture</a> - The bus that carries the data.</li>
</ul>
<pre><code>
```markdown
---
title: &quot;WTF is the Windows I/O Request Packet (IRP)?&quot;
date: 2025-11-28
draft: false
tags:
  - windows
  - kernel
  - deep-dive
  - architecture
description: &quot;The bureaucratic form that powers every single input and output operation in Windows.&quot;
---

# WTF is the Windows I/O Request Packet (IRP)?

*The &quot;TPS Report&quot; of the Kernel.*

In Linux, when you call `read()`, the thread blocks, the kernel does the work, and the thread wakes up. It's direct.
In Windows, the Input/Output system is **fundamentally asynchronous** and **packet-driven**.

You don't &quot;do&quot; the work. You fill out a form requesting the work be done, submit it to the Department of I/O, and wait for a callback. That form is the **IRP (I/O Request Packet)**.

## The Core Analogy

Think of a Windows Driver request like **Ordering a Pizza**:

1.  **The App:** You call `ReadFile()`. This is you calling the pizza place.
2.  **The I/O Manager:** The person on the phone. They don't cook. They write down your order on a **Ticket (The IRP)**.
3.  **The Stack:** The ticket gets passed to the Kitchen Manager (File System Driver), who passes it to the Chef (Disk Driver), who passes it to the Delivery Guy (Bus Driver).
4.  **Pending:** While the pizza is cooking, the phone operator doesn't hang on the line. They say &quot;We'll text you when it's done&quot; (**STATUS_PENDING**) and hang up so they can take other calls.
5.  **Completion:** When the pizza arrives, you get a notification.

## The Anatomy of an IRP

The `IRP` is a massive C structure defined in `wdm.h`. It has two main parts:

### 1. The Header (Fixed Size)
Contains global metadata about the request.
*   **`IoStatus`**: The final result (Success/Fail) and bytes transferred.
*   **`UserBuffer`**: Pointer to where the data should go (your application's memory).
*   **`Cancel`**: A boolean flag. Can we abort this mission?

### 2. The I/O Stack Locations (Variable Size)
This is the clever part. An IRP has an array of &quot;Stack Locations&quot;—one for each driver in the chain.
*   **Why?** The File System Driver needs to know the **Filename**. The Disk Driver doesn't care about filenames; it needs **Sector Numbers**.
*   As the IRP moves down, `IoCallDriver` advances the stack pointer so the next driver sees its own specific parameters.

## The Code: Handling an IRP

Here is what a driver actually does when it catches this packet.

```c
NTSTATUS MyDriverDispatchRead(PDEVICE_OBJECT DeviceObject, PIRP Irp) {
    // 1. Get the current stack location (My private notes)
    PIO_STACK_LOCATION stack = IoGetCurrentIrpStackLocation(Irp);
    
    // 2. Read parameters specific to ME
    ULONG length = stack->Parameters.Read.Length;
    LONGLONG offset = stack->Parameters.Read.ByteOffset;

    KdPrint((&quot;Request to read %d bytes from offset %lld\n&quot;, length, offset));

    // 3. Do the work (Simulated here)
    // In reality, we might pass this to hardware or queue it.
    
    // ... Copy data to Irp->AssociatedIrp.SystemBuffer ...

    // 4. Complete the Request (Stamp the ticket)
    Irp->IoStatus.Status = STATUS_SUCCESS;
    Irp->IoStatus.Information = length; // Bytes transferred
    
    // 5. Send it back up the chain
    IoCompleteRequest(Irp, IO_NO_INCREMENT);

    return STATUS_SUCCESS;
}
</code></pre>
<h2 id="the-pending-nightmare">The “Pending” Nightmare<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#the-pending-nightmare" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>The most confusing part of Windows drivers is <strong><code>STATUS_PENDING</code></strong>.</p>
<p>If a driver needs to wait for hardware (like a hard drive spin-up), it cannot block the CPU.</p>
<ol>
<li>The driver marks the IRP as Pending.</li>
<li>It queues the IRP in an internal list.</li>
<li>It returns <code>STATUS_PENDING</code> to the caller immediately.</li>
<li>… 10 milliseconds later …</li>
<li>The hardware interrupts. The driver finds the IRP in the list, finishes the work, and calls <code>IoCompleteRequest</code>.</li>
</ol>
<p>This is why Windows is so heavy on “Async I/O” (Overlapped I/O). The OS was built for it from day one.</p>
<h2 id="verification--sources">Verification &amp; Sources<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#verification--sources" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p><strong>Verified during writing:</strong></p>
<ul>
<li><code>struct _IRP</code> definition in generic Windows Driver Kit (WDK).</li>
<li><code>IoGetCurrentIrpStackLocation</code> macro behavior.</li>
<li>Asynchronous I/O design patterns in Windows Internals (Part 2).</li>
</ul>
<p><strong>To double-check this article:</strong></p>
<ol>
<li>Search <code>&quot;IRP major function codes&quot;</code>.</li>
<li>Look up <code>&quot;Windows Overlapped I/O&quot;</code>.</li>
</ol>
<h2 id="whats-next-1">What’s Next<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#whats-next-1" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>Now we know how the Kernel moves data. But how does that data get to your Game Loop or GUI? Does the Kernel call your function? No. It puts a message in your mailbox.</p>
<p>Next article: <strong>WTF is the Windows Message Queue?</strong></p>
<p><strong>Related:</strong></p>
<ul>
<li><a href="../WTF-is-the-Windows-Driver-Stack" class="internal alias" data-slug="WTF-is-the-Windows-Driver-Stack">WTF is the Windows Driver Stack?</a> - The context for IRPs.</li>
<li><a href="../Interrupts" class="internal" data-slug="Interrupts">Interrupts</a> - What wakes the driver up to complete the IRP.</li>
</ul>
<pre><code>
```markdown
---
title: &quot;WTF is Raw Input?&quot;
date: 2025-11-28
draft: false
tags:
  - windows
  - gamedev
  - input
  - performance
description: &quot;How to bypass Windows' helpfulness to get the pure, unfiltered data stream from your mouse.&quot;
---

# WTF is Raw Input?

*Drinking from the firehose.*

Windows was designed in the 80s for word processors. It tries very hard to be helpful.
If you move your mouse fast, Windows applies &quot;Ballistics&quot; (Acceleration) to help you navigate the desktop. If you press a key, Windows waits a bit before repeating it (Typematic rate) so you don't type &quot;Aaaaaaaa&quot;.

**For a competitive shooter game, this &quot;help&quot; is poison.**

You want 1:1 movement. If you move the mouse 1 inch, you want the camera to turn exactly X degrees, regardless of how fast you moved.

**Raw Input** is the API that lets you bypass the desktop cursor logic and read data directly from the HID stack.

## The Core Analogy

*   **Standard Input (`WM_MOUSEMOVE`):** The &quot;Edited for TV&quot; version of a movie. The naughty bits are cut out, the speed is adjusted for pacing, and it's formatted to fit your screen resolution.
*   **Raw Input (`WM_INPUT`):** The Master Tapes. Every frame, every glitch, exactly as it was shot.

## The Problem with `WM_MOUSEMOVE`

1.  **Clamping:** It stops at the edge of the screen. If you play a game, you have to constantly warp the cursor back to the center (`SetCursorPos`), which creates jitter.
2.  **Acceleration:** Windows modifies the data based on user Control Panel settings.
3.  **Loss of Precision:** `WM_MOUSEMOVE` gives you pixels. High-end mice have resolutions much higher than your monitor. Windows throws that extra data away.

## How It Works

To use Raw Input, you must explicitly **Register** for it. You tell the OS: &quot;I want to hear from the Mouse HID device directly.&quot;

### 1. Registration
You use `RegisterRawInputDevices`. You specify &quot;Generic Desktop Page&quot; (0x01) and &quot;Mouse&quot; (0x02).

### 2. The Message Loop
Windows stops hiding the messages. It starts sending `WM_INPUT` messages to your window.

### 3. Parsing
Inside `WM_INPUT`, you don't get X/Y coordinates on screen. You get **Deltas** (LastX - CurrentX).

## Code Example: The Raw Input Loop

Here is the minimum code required to read raw mouse deltas in a Win32 app.

```c
#include &lt;windows.h>
#include &lt;hidusage.h>
#include &lt;stdio.h>

// 1. Setup
void InitRawInput(HWND hwnd) {
    RAWINPUTDEVICE Rid[1];
    Rid[0].usUsagePage = HID_USAGE_PAGE_GENERIC; 
    Rid[0].usUsage = HID_USAGE_GENERIC_MOUSE; 
    Rid[0].dwFlags = RIDEV_INPUTSINK; // Get input even when in background!
    Rid[0].hwndTarget = hwnd;

    if (RegisterRawInputDevices(Rid, 1, sizeof(Rid[0])) == FALSE) {
        printf(&quot;Registration failed.\n&quot;);
    }
}

// 2. The Message Handler
LRESULT CALLBACK WndProc(HWND hwnd, UINT msg, WPARAM wParam, LPARAM lParam) {
    if (msg == WM_INPUT) {
        UINT dwSize = 0;
        
        // Ask for buffer size first
        GetRawInputData((HRAWINPUT)lParam, RID_INPUT, NULL, &amp;dwSize, 
                        sizeof(RAWINPUTHEADER));
        
        LPBYTE lpb = new BYTE[dwSize];
        if (lpb == NULL) return 0; 

        // Get the actual data
        if (GetRawInputData((HRAWINPUT)lParam, RID_INPUT, lpb, &amp;dwSize, 
                            sizeof(RAWINPUTHEADER)) != (UINT)-1) {
            
            RAWINPUT* raw = (RAWINPUT*)lpb;

            if (raw->header.dwType == RIM_TYPEMOUSE) {
                // Here is the Holy Grail: Raw Deltas
                int dx = raw->data.mouse.lLastX;
                int dy = raw->data.mouse.lLastY;
                
                printf(&quot;Raw Delta: [%d, %d]\n&quot;, dx, dy);
            }
        }
        delete[] lpb;
        return 0; // Handled
    }
    return DefWindowProc(hwnd, msg, wParam, lParam);
}
</code></pre>
<h2 id="raw-input-vs-directinput">Raw Input vs DirectInput<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#raw-input-vs-directinput" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<blockquote class="callout tip" data-callout="tip">
<div class="callout-title">
                  <div class="callout-icon"></div>
                  <div class="callout-title-inner"><p>History Lesson </p></div>
                  
                </div>
<div class="callout-content">
<p>In the 90s/00s, games used <strong>DirectInput</strong> (part of DirectX).
<strong>DirectInput is dead.</strong> Do not use it.
Under the hood, modern DirectInput is just a wrapper around Raw Input, but it adds lag and complexity. Microsoft explicitly recommends using Raw Input (<code>WM_INPUT</code>) for mouse/keyboard and <strong>XInput</strong> for controllers.</p>
</div>
</blockquote>
<h2 id="whats-next-2">What’s Next<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#whats-next-2" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>We are catching <code>WM_INPUT</code> messages. But what <em>is</em> a message? Why do we have a <code>WndProc</code>?</p>
<p>Next article: <strong>WTF is the Windows Message Queue?</strong></p>
<p><strong>Related:</strong></p>
<ul>
<li><a href="../WTF-is-HIDCLASS.SYS" class="internal alias" data-slug="WTF-is-HIDCLASS.SYS">WTF is HIDCLASS.SYS?</a> - The source of this data.</li>
<li><a href="../Architecture/Scancodes,-Keycodes,-and-Virtual-Keys" class="internal alias" data-slug="Architecture/Scancodes,-Keycodes,-and-Virtual-Keys">Scancodes, Keycodes, and Virtual Keys</a> - What you get inside the keyboard Raw Input.</li>
</ul>
<pre><code>
```markdown
---
title: &quot;WTF is the Windows Message Queue?&quot;
date: 2025-11-28
draft: false
tags:
  - windows
  - architecture
  - programming
  - event-loop
description: &quot;The mailbox system that powers every click, keypress, and window resize in Windows.&quot;
---

# WTF is the Windows Message Queue?

*The &quot;Take a Number&quot; deli counter of the OS.*

In Console land (standard C `main`), the program runs top to bottom.
In GUI land (Windows), the program sits in a loop doing absolutely nothing, waiting for the OS to hand it a note.

This note is a **Message**.
The waiting line is the **Message Queue**.

If you've ever seen a Windows application turn white and say &quot;Not Responding,&quot; it's because the application stopped checking its mailbox.

## The Core Analogy

Think of a Window (`HWND`) as a **Clerk at a Desk**.
Think of the User as an angry customer throwing requests at the clerk.

1.  **The Queue:** The customer (OS) puts requests (&quot;Paint yourself&quot;, &quot;Key Pressed&quot;, &quot;Mouse Clicked&quot;) into the clerk's Inbox.
2.  **The Loop (`GetMessage`):** The clerk picks up the top paper from the Inbox.
3.  **The Dispatch (`DispatchMessage`):** The clerk reads it and decides what to do.
4.  **The Procedure (`WndProc`):** The specific instruction manual for handling that request.

If the clerk decides to calculate Pi to a billion digits while holding a note, they stop checking the Inbox. The Inbox fills up. The OS notices the Inbox is full and declares the app &quot;Frozen.&quot;

## The Architecture

Every thread that creates a Window gets a **Message Queue**.

### The Message Struct (`MSG`)
Every event is boiled down to this C structure:
```c
struct MSG {
    HWND   hwnd;     // Which window is this for?
    UINT   message;  // The ID (e.g., WM_KEYDOWN = 0x0100)
    WPARAM wParam;   // Data A (e.g., The Key Code 'A')
    LPARAM lParam;   // Data B (e.g., Shift state or mouse coordinates)
    DWORD  time;     // Timestamp
    POINT  pt;       // Mouse position when it happened
};
</code></pre>
<h3 id="the-pump-the-heartbeat">The “Pump” (The Heartbeat)<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#the-pump-the-heartbeat" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p>This is the standard boilerplate code found in every Win32 app since 1990:</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="c" data-theme="github-light github-dark"><code data-language="c" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MSG msg;</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 1. GetMessage: Blocks (sleeps) until a message arrives</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">GetMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">msg</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)) {</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 2. Translate: Converts KeyDown events into Character events</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    TranslateMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">msg);</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 3. Dispatch: Calls your 'WndProc' function with the message</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    DispatchMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">msg);</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></figure>
<h2 id="post-vs-send-the-two-types-of-mail">Post vs Send: The Two Types of Mail<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#post-vs-send-the-two-types-of-mail" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>This distinction causes endless bugs.</p>
<ol>
<li>
<p><strong><code>PostMessage</code> (Async):</strong></p>
<ul>
<li>“Put this note in the inbox and leave.”</li>
<li>The function returns immediately. The receiver will get to it when they get to it.</li>
<li>Used for: Input events (<code>WM_KEYDOWN</code>), Quit commands (<code>WM_QUIT</code>).</li>
</ul>
</li>
<li>
<p><strong><code>SendMessage</code> (Sync):</strong></p>
<ul>
<li>“Walk up to the clerk, slap the note on the desk, and stand there until they finish the task.”</li>
<li>Bypasses the queue. Calls the <code>WndProc</code> directly.</li>
<li>Used for: Resizing (<code>WM_SIZE</code>), getting text (<code>WM_GETTEXT</code>).</li>
<li><strong>Danger:</strong> If you <code>SendMessage</code> to a frozen window, <em>you</em> freeze too.</li>
</ul>
</li>
</ol>
<h2 id="wtf-is-wm_paint">WTF is <code>WM_PAINT</code>?<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#wtf-is-wm_paint" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>This is the most misunderstood message.
The OS doesn’t send <code>WM_PAINT</code> repeatedly. It sets a “Paint Flag” on the queue.
When the queue is <strong>empty</strong> (no keys, no clicks), the OS checks the flag. If it’s up, it generates a <code>WM_PAINT</code>.</p>
<p>This is a low-priority message. Windows prioritizes Input (Mouse/Keyboard) over Drawing. This keeps the mouse smooth even if the rendering is lagging.</p>
<h2 id="whats-next-3">What’s Next<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#whats-next-3" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>Inside <code>WM_KEYDOWN</code>, <code>wParam</code> contains a number representing the key. But it’s not ASCII. It’s a Virtual Key Code.</p>
<p>Next article: <strong>WTF are Virtual Key Codes?</strong></p>
<p><strong>Related:</strong></p>
<ul>
<li><a href="../WTF-is-Raw-Input" class="internal alias" data-slug="WTF-is-Raw-Input">WTF is Raw Input?</a> - A message type that bypasses standard processing.</li>
<li><a href="../Interrupts" class="internal" data-slug="Interrupts">Interrupts</a> - The hardware event that eventually becomes a Message.</li>
</ul>
<pre><code>
```markdown
---
title: &quot;WTF are Virtual Key Codes?&quot;
date: 2025-11-28
draft: false
tags:
  - windows
  - input
  - legacy
  - programming
description: &quot;Why the Enter key is 0x0D, why Shift is two different keys, and other relics of the past.&quot;
---

# WTF are Virtual Key Codes?

*The Esperanto of Windows Keyboards.*

Hardware keyboards speak **Scancodes** (Scan Code Set 1, 2, HID, etc.). These are chaotic and depend on physical wiring.
To make life livable for programmers, Windows adds an abstraction layer: **Virtual Key Codes (VK)**.

A Virtual Key is a promise: `VK_A` (0x41) will always represent the &quot;A&quot; command, whether you are using a US Keyboard, a German Keyboard, or a Foot Pedal mapped to &quot;A&quot;.

## The Core Analogy

*   **Scancode:** &quot;Button #30 on the matrix was pressed.&quot; (Physical implementation).
*   **Virtual Key:** &quot;The user wants to input the letter 'A'.&quot; (Logical Intent).

## The Constants (`WinUser.h`)

If you look at the header file, you see history staring back at you.

*   `VK_LBUTTON` (0x01): Left Mouse Button.
*   `VK_BACK` (0x08): Backspace.
*   `VK_RETURN` (0x0D): Enter. (Matches ASCII Carriage Return).
*   `VK_A` thru `VK_Z`: Matches ASCII 'A'-'Z' (0x41 - 0x5A).
*   `VK_0` thru `VK_9`: Matches ASCII '0'-'9'.

> [!note] The Missing Constants
> 
> You will notice `WinUser.h` doesn't actually define `VK_A`. It expects you to just use the character literal `'A'`.

## The Problem: Left vs Right

The early IBM PC keyboards didn't distinguish between Left Shift and Right Shift. They were just &quot;Shift&quot;.
Windows defines `VK_SHIFT` (0x10).

But games need to know the difference.
So Windows introduced:
*   `VK_LSHIFT` (0xA0)
*   `VK_RSHIFT` (0xA1)

**The Trap:**
When you get a `WM_KEYDOWN` message, `wParam` is usually the generic `VK_SHIFT`. If you want the specific one, you have to query the hardware state or check the `lParam` flags.

## Translating Codes: `MapVirtualKey`

Sometimes you have a VK and need the Scancode (to simulate hardware), or vice versa.
Windows provides the Rosetta Stone function: **`MapVirtualKey(uCode, uMapType)`**.

*   `MAPVK_VK_TO_VSC`: Virtual Key -> Scan Code.
*   `MAPVK_VSC_TO_VK`: Scan Code -> Virtual Key.

**Example:**
In a shooter game, you want the &quot;W&quot; key to move forward.
*   On a US Keyboard, &quot;W&quot; is `VK_W`.
*   On a French (AZERTY) Keyboard, the physical key where &quot;W&quot; sits is actually &quot;Z&quot;.
*   If you bind &quot;Move Forward&quot; to `VK_W`, the French player has to reach down to the bottom of the keyboard to walk.
*   **Solution:** Bind to the **Scancode** for physical location consistency. Use `MapVirtualKey` to display the correct name in the UI (&quot;Press Z to walk&quot;).

## Code Example: Polling State

You can ask Windows &quot;Is this key down right now?&quot; without waiting for a message.

```c
#include &lt;windows.h>
#include &lt;stdio.h>

int main() {
    // 0x8000 is the bit mask for &quot;Currently Down&quot;
    if (GetAsyncKeyState(VK_SPACE) &amp; 0x8000) {
        printf(&quot;Spacebar is being held!\n&quot;);
    }
    
    // Check specific left shift
    if (GetAsyncKeyState(VK_LSHIFT) &amp; 0x8000) {
        printf(&quot;Left Shift down!\n&quot;);
    }
}
</code></pre>
<blockquote class="callout warning" data-callout="warning">
<div class="callout-title">
                  <div class="callout-icon"></div>
                  <div class="callout-title-inner"><p> <code>GetAsyncKeyState</code> vs <code>GetKeyState</code></p></div>
                  
                </div>
<div class="callout-content">
<ul>
<li><code>GetAsyncKeyState</code>: Real-time hardware check. “Is it down <em>now</em>?”</li>
<li><code>GetKeyState</code>: Syncs with the message queue. “Was it down when this message was generated?”
Use <code>Async</code> for games/tools. Use <code>Key</code> for typing/text boxes.</li>
</ul>
</div>
</blockquote>
<h2 id="whats-next-4">What’s Next<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#whats-next-4" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>We know how to read input. But how do we fake it? How do we build a macro bot or a remote control tool?</p>
<p>Next article: <strong>WTF is Virtual Input? (uinput vs SendInput)</strong></p>
<p><strong>Related:</strong></p>
<ul>
<li><a href="../Architecture/Scancodes,-Keycodes,-and-Virtual-Keys" class="internal alias" data-slug="Architecture/Scancodes,-Keycodes,-and-Virtual-Keys">Scancodes, Keycodes, and Virtual Keys</a> - The theory behind the codes.</li>
<li><a href="../WTF-is-the-Windows-Message-Queue" class="internal alias" data-slug="WTF-is-the-Windows-Message-Queue">WTF is the Windows Message Queue?</a> - Where VKs appear.</li>
</ul>
<pre><code>
```markdown
---
title: &quot;WTF is Virtual Input? (uinput vs SendInput)&quot;
date: 2025-11-28
draft: false
tags:
  - windows
  - linux
  - automation
  - botting
  - comparison
description: &quot;How to programmatically press keys and move mice, and why Linux does it better.&quot;
---

# WTF is Virtual Input? (uinput vs SendInput)

*Ghost in the Machine.*

Sometimes you want to be the user. You want to write a script that types &quot;Hello&quot;, a bot that farms gold in an MMORPG, or a remote desktop server that relays clicks from a phone to a PC.

This requires **Input Injection**.

Windows and Linux take radically different approaches to this. Windows lets you fake the *Message*, while Linux lets you fake the *Hardware*.

## Windows: `SendInput` (The High-Level Liar)

Windows provides a Win32 API function called `SendInput`.

### How It Works
It inserts input events directly into the **System Message Queue**.
1.  You create an array of `INPUT` structures.
2.  You call `SendInput`.
3.  Windows injects these events into the stream just after the hardware driver processing.

### The Catch
It is flagged.
Windows adds a specific flag (`LLKHF_INJECTED`) to these events.
*   **Anti-Cheat:** Games check this flag. If they see a mouse click with the &quot;Injected&quot; flag, you get banned.
*   **Privilege:** You cannot send input to a window running as Administrator unless your script is also Administrator (UIPI - User Interface Privilege Isolation).

### Code Example (C++)
```cpp
INPUT inputs[2] = {};

// 1. Press 'A'
inputs[0].type = INPUT_KEYBOARD;
inputs[0].ki.wVk = 'A';

// 2. Release 'A'
inputs[1].type = INPUT_KEYBOARD;
inputs[1].ki.wVk = 'A';
inputs[1].ki.dwFlags = KEYEVENTF_KEYUP;

SendInput(2, inputs, sizeof(INPUT));
</code></pre>
<h2 id="linux-uinput-the-fake-hardware">Linux: <code>uinput</code> (The Fake Hardware)<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#linux-uinput-the-fake-hardware" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>Linux is cooler. Linux lets you create a <strong>Virtual Device</strong>.
Using the <code>uinput</code> kernel module, you can create a file <code>/dev/input/eventX</code> that looks exactly like a physical USB keyboard to the OS.</p>
<h3 id="how-it-works">How It Works<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#how-it-works" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<ol>
<li>Open <code>/dev/uinput</code>.</li>
<li>Configure the device (Name: “My Fake Keyboard”, Capabilities: Keys A-Z).</li>
<li>Call <code>ioctl(UI_DEV_CREATE)</code>.</li>
<li>Write <code>struct input_event</code> data to the file.</li>
</ol>
<h3 id="the-advantage">The Advantage<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#the-advantage" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<ul>
<li><strong>Transparency:</strong> To the application (and X11/Wayland), this looks like real hardware. There is no “Injected” flag. It appears in <code>lsusb</code> (sort of) and <code>evtest</code>.</li>
<li><strong>Power:</strong> You can create pressure-sensitive tablets, joysticks, or multitouch screens entirely in software.</li>
</ul>
<h3 id="code-example-c">Code Example (C)<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#code-example-c" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="c" data-theme="github-light github-dark"><code data-language="c" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Setup omitted for brevity... </span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// We are writing to the file descriptor of the virtual device</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> input_event ev;</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">memset</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ev</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ev));</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Press 'A'</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ev.type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> EV_KEY;</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ev.code </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> KEY_A;</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ev.value </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // Press</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">write</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(fd, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ev</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ev));</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Sync (The &quot;Frame&quot; boundary)</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ev.type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> EV_SYN;</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ev.code </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SYN_REPORT;</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ev.value </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">write</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(fd, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ev</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ev));</span></span></code></pre></figure>
<h2 id="comparison-table">Comparison Table<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#comparison-table" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>



































<div class="table-container"><table><thead><tr><th style="text-align:left;">Feature</th><th style="text-align:left;">Windows (<code>SendInput</code>)</th><th style="text-align:left;">Linux (<code>uinput</code>)</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>Level</strong></td><td style="text-align:left;">Message Queue (High)</td><td style="text-align:left;">Kernel Driver (Low)</td></tr><tr><td style="text-align:left;"><strong>Setup</strong></td><td style="text-align:left;">Zero (Just call API)</td><td style="text-align:left;">High (Open file, configure struct)</td></tr><tr><td style="text-align:left;"><strong>Detection</strong></td><td style="text-align:left;">Easy (<code>LLKHF_INJECTED</code>)</td><td style="text-align:left;">Hard (Looks like hardware)</td></tr><tr><td style="text-align:left;"><strong>Flexibility</strong></td><td style="text-align:left;">Limited (Keyboard/Mouse)</td><td style="text-align:left;">Infinite (Joysticks, Touch, etc.)</td></tr><tr><td style="text-align:left;"><strong>Permissions</strong></td><td style="text-align:left;">User (mostly)</td><td style="text-align:left;">Root / <code>input</code> group</td></tr></tbody></table></div>
<h2 id="which-one-should-i-use">Which One Should I Use?<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#which-one-should-i-use" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<ul>
<li><strong>Automation Scripts:</strong> <code>SendInput</code> (Windows) / <code>xdotool</code> (Linux X11).</li>
<li><strong>Game Bots:</strong> <code>uinput</code> (Linux) or writing a custom Kernel Driver (Windows).</li>
<li><strong>Remote Desktop Software:</strong> <code>uinput</code> (Linux) / <code>SendInput</code> (Windows).</li>
</ul>
<h2 id="whats-next-5">What’s Next<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#whats-next-5" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>We have explored the depths of both systems. Let’s wrap up by comparing the philosophies of Windows and Linux input architectures side-by-side.</p>
<p>Next article: <strong>Linux vs Windows: Input Philosophy</strong></p>
<p><strong>Related:</strong></p>
<ul>
<li><a href="../WTF-is-evdev" class="internal alias" data-slug="WTF-is-evdev">WTF is evdev?</a> - The protocol uinput speaks.</li>
<li><a href="../WTF-is-the-Windows-Message-Queue" class="internal alias" data-slug="WTF-is-the-Windows-Message-Queue">WTF is the Windows Message Queue?</a> - Where SendInput dumps its payload.</li>
</ul>
<pre><code>
```markdown
---
title: &quot;Linux vs Windows: Input Philosophy&quot;
date: 2025-11-28
draft: false
tags:
  - windows
  - linux
  - architecture
  - comparison
  - philosophy
description: &quot;Everything is a File vs. Everything is an Object. A final showdown.&quot;
---

# Linux vs Windows: Input Philosophy

*Two roads diverged in a system architecture...*

We have spent the last few articles diving into IRPs, Nodes, Messages, and Files. Now, let's zoom out.

Why are they so different?
It comes down to the fundamental religion of each Kernel.

## 1. The Core Abstraction

### Linux: &quot;Everything is a File&quot; (The Stream)
*   **Philosophy:** Input is just a stream of bytes, like a text file.
*   **Implementation:** You `open()` a keyboard. You `read()` events. You `write()` to LEDs.
*   **Benefit:** Universal tooling. You can use `cat`, `grep`, and standard C file APIs to debug hardware.
*   **Drawback:** It requires parsing. You have to interpret the byte stream.

### Windows: &quot;Everything is an Object&quot; (The Packet)
*   **Philosophy:** Input is a structured Request (IRP) traveling through a rigid hierarchy.
*   **Implementation:** You don't read bytes; you send a formatted Request Packet to a Device Object.
*   **Benefit:** Extensibility. You can layer filters (Antivirus, Encryption) easily because everyone agrees on the Packet format.
*   **Drawback:** Complexity. You need the DDK/WDK and special tools to inspect anything.

## 2. Asynchrony

### Linux: Blocking by Default
*   Traditionally, `read()` blocks the thread until a key is pressed.
*   Modern Linux uses `epoll` / `io_uring` for async, but the mental model is still &quot;wait for data.&quot;

### Windows: Async by Default
*   The I/O Manager was built to be async (Overlapped I/O) from Day 1 (VMS heritage).
*   Drivers return `STATUS_PENDING`. The OS is designed to keep the CPU moving while hardware is slow.

## 3. The User Space Boundary

### Linux: The Kernel does the Heavy Lifting
*   The Kernel (Input Core) translates Scancodes to standardized Keycodes (`KEY_A`).
*   User space (`libinput`) gets clean, normalized data.

### Windows: The User Space does the Heavy Lifting
*   The Kernel passes raw-ish data up.
*   The Window Manager (`win32k.sys` / `user32.dll`) handles the massive complexity of Layouts, Virtual Keys, Sticky Keys, and Repeat Rates.
*   This makes the Windows Kernel slightly &quot;dumber&quot; (in a good way) regarding specific language layouts, leaving that policy to the upper layers.

## The Verdict

**Linux** is better for:
*   Embedded devices.
*   Robotics (easy to read sensors).
*   Servers (headless input).
*   **Transparency:** You can see exactly what is happening.

**Windows** is better for:
*   Desktop backward compatibility.
*   Complex device stacks (e.g., a virtual encrypted keyboard over a network).
*   **Resilience:** Ideally, a driver crash can be recovered (in modern UMDF), whereas a bad kernel module in Linux often panics the box.

## Final Summary of the Series

1.  **Hardware** sends voltage.
2.  **Controller** sends Scancodes.
3.  **Kernel** (Linux Input Core / Windows HIDCLASS) normalizes it.
4.  **OS** (evdev / Windows Message Queue) presents it to the App.
5.  **App** (Game / Browser) renders the character.

It is a miracle that typing &quot;A&quot; works at all.

**Related:**
- [[WTF is the Linux Input Core?]]
- [[WTF is the Windows Driver Stack?]]
</code></pre></article><hr/><div class="page-footer"></div></div><div class="right sidebar"><div class="graph"><h3>Graph View</h3><div class="graph-outer"><div class="graph-container" data-cfg="{&quot;drag&quot;:true,&quot;zoom&quot;:true,&quot;depth&quot;:1,&quot;scale&quot;:1.1,&quot;repelForce&quot;:0.5,&quot;centerForce&quot;:0.3,&quot;linkDistance&quot;:30,&quot;fontSize&quot;:0.6,&quot;opacityScale&quot;:1,&quot;showTags&quot;:true,&quot;removeTags&quot;:[],&quot;focusOnHover&quot;:false,&quot;enableRadial&quot;:false}"></div><button class="global-graph-icon" aria-label="Global Graph"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 55 55" fill="currentColor" xml:space="preserve"><path d="M49,0c-3.309,0-6,2.691-6,6c0,1.035,0.263,2.009,0.726,2.86l-9.829,9.829C32.542,17.634,30.846,17,29,17
                s-3.542,0.634-4.898,1.688l-7.669-7.669C16.785,10.424,17,9.74,17,9c0-2.206-1.794-4-4-4S9,6.794,9,9s1.794,4,4,4
                c0.74,0,1.424-0.215,2.019-0.567l7.669,7.669C21.634,21.458,21,23.154,21,25s0.634,3.542,1.688,4.897L10.024,42.562
                C8.958,41.595,7.549,41,6,41c-3.309,0-6,2.691-6,6s2.691,6,6,6s6-2.691,6-6c0-1.035-0.263-2.009-0.726-2.86l12.829-12.829
                c1.106,0.86,2.44,1.436,3.898,1.619v10.16c-2.833,0.478-5,2.942-5,5.91c0,3.309,2.691,6,6,6s6-2.691,6-6c0-2.967-2.167-5.431-5-5.91
                v-10.16c1.458-0.183,2.792-0.759,3.898-1.619l7.669,7.669C41.215,39.576,41,40.26,41,41c0,2.206,1.794,4,4,4s4-1.794,4-4
                s-1.794-4-4-4c-0.74,0-1.424,0.215-2.019,0.567l-7.669-7.669C36.366,28.542,37,26.846,37,25s-0.634-3.542-1.688-4.897l9.665-9.665
                C46.042,11.405,47.451,12,49,12c3.309,0,6-2.691,6-6S52.309,0,49,0z M11,9c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2
                S11,10.103,11,9z M6,51c-2.206,0-4-1.794-4-4s1.794-4,4-4s4,1.794,4,4S8.206,51,6,51z M33,49c0,2.206-1.794,4-4,4s-4-1.794-4-4
                s1.794-4,4-4S33,46.794,33,49z M29,31c-3.309,0-6-2.691-6-6s2.691-6,6-6s6,2.691,6,6S32.309,31,29,31z M47,41c0,1.103-0.897,2-2,2
                s-2-0.897-2-2s0.897-2,2-2S47,39.897,47,41z M49,10c-2.206,0-4-1.794-4-4s1.794-4,4-4s4,1.794,4,4S51.206,10,49,10z"></path></svg></button></div><div class="global-graph-outer"><div class="global-graph-container" data-cfg="{&quot;drag&quot;:true,&quot;zoom&quot;:true,&quot;depth&quot;:-1,&quot;scale&quot;:0.9,&quot;repelForce&quot;:0.5,&quot;centerForce&quot;:0.2,&quot;linkDistance&quot;:30,&quot;fontSize&quot;:0.6,&quot;opacityScale&quot;:1,&quot;showTags&quot;:true,&quot;removeTags&quot;:[],&quot;focusOnHover&quot;:true,&quot;enableRadial&quot;:true}"></div></div></div><div class="toc desktop-only"><button type="button" class="toc-header" aria-controls="toc-7" aria-expanded="true"><h3>Table of Contents</h3><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="fold"><polyline points="6 9 12 15 18 9"></polyline></svg></button><ul id="list-1" class="toc-content overflow"><li class="depth-0"><a href="#common-misconceptions" data-for="common-misconceptions">Common Misconceptions</a></li><li class="depth-0"><a href="#whats-next" data-for="whats-next">What’s Next</a></li><li class="depth-0"><a href="#the-pending-nightmare" data-for="the-pending-nightmare">The “Pending” Nightmare</a></li><li class="depth-0"><a href="#verification--sources" data-for="verification--sources">Verification &amp; Sources</a></li><li class="depth-0"><a href="#whats-next-1" data-for="whats-next-1">What’s Next</a></li><li class="depth-0"><a href="#raw-input-vs-directinput" data-for="raw-input-vs-directinput">Raw Input vs DirectInput</a></li><li class="depth-0"><a href="#whats-next-2" data-for="whats-next-2">What’s Next</a></li><li class="depth-1"><a href="#the-pump-the-heartbeat" data-for="the-pump-the-heartbeat">The “Pump” (The Heartbeat)</a></li><li class="depth-0"><a href="#post-vs-send-the-two-types-of-mail" data-for="post-vs-send-the-two-types-of-mail">Post vs Send: The Two Types of Mail</a></li><li class="depth-0"><a href="#wtf-is-wm_paint" data-for="wtf-is-wm_paint">WTF is WM_PAINT?</a></li><li class="depth-0"><a href="#whats-next-3" data-for="whats-next-3">What’s Next</a></li><li class="depth-0"><a href="#whats-next-4" data-for="whats-next-4">What’s Next</a></li><li class="depth-0"><a href="#linux-uinput-the-fake-hardware" data-for="linux-uinput-the-fake-hardware">Linux: uinput (The Fake Hardware)</a></li><li class="depth-1"><a href="#how-it-works" data-for="how-it-works">How It Works</a></li><li class="depth-1"><a href="#the-advantage" data-for="the-advantage">The Advantage</a></li><li class="depth-1"><a href="#code-example-c" data-for="code-example-c">Code Example (C)</a></li><li class="depth-0"><a href="#comparison-table" data-for="comparison-table">Comparison Table</a></li><li class="depth-0"><a href="#which-one-should-i-use" data-for="which-one-should-i-use">Which One Should I Use?</a></li><li class="depth-0"><a href="#whats-next-5" data-for="whats-next-5">What’s Next</a></li><li class="overflow-end"></li></ul></div></div><footer class><p>Created with <a href="https://quartz.jzhao.xyz/">Quartz v1.0.0</a> © 2025</p><ul><li><a href="https://github.com/tham-le">GitHub</a></li><li><a href="https://thamle.live">Portfolio</a></li></ul></footer></div></div></body><script type="application/javascript">function n(){let t=this.parentElement;t.classList.toggle("is-collapsed");let e=t.getElementsByClassName("callout-content")[0];if(!e)return;let l=t.classList.contains("is-collapsed");e.style.gridTemplateRows=l?"0fr":"1fr"}function c(){let t=document.getElementsByClassName("callout is-collapsible");for(let e of t){let l=e.getElementsByClassName("callout-title")[0],s=e.getElementsByClassName("callout-content")[0];if(!l||!s)continue;l.addEventListener("click",n),window.addCleanup(()=>l.removeEventListener("click",n));let o=e.classList.contains("is-collapsed");s.style.gridTemplateRows=o?"0fr":"1fr"}}document.addEventListener("nav",c);
</script><script type="module">function f(i,e){if(!i)return;function r(o){o.target===this&&(o.preventDefault(),o.stopPropagation(),e())}function t(o){o.key.startsWith("Esc")&&(o.preventDefault(),e())}i?.addEventListener("click",r),window.addCleanup(()=>i?.removeEventListener("click",r)),document.addEventListener("keydown",t),window.addCleanup(()=>document.removeEventListener("keydown",t))}function y(i){for(;i.firstChild;)i.removeChild(i.firstChild)}var h=class{constructor(e,r){this.container=e;this.content=r;this.setupEventListeners(),this.setupNavigationControls(),this.resetTransform()}isDragging=!1;startPan={x:0,y:0};currentPan={x:0,y:0};scale=1;MIN_SCALE=.5;MAX_SCALE=3;cleanups=[];setupEventListeners(){let e=this.onMouseDown.bind(this),r=this.onMouseMove.bind(this),t=this.onMouseUp.bind(this),o=this.resetTransform.bind(this);this.container.addEventListener("mousedown",e),document.addEventListener("mousemove",r),document.addEventListener("mouseup",t),window.addEventListener("resize",o),this.cleanups.push(()=>this.container.removeEventListener("mousedown",e),()=>document.removeEventListener("mousemove",r),()=>document.removeEventListener("mouseup",t),()=>window.removeEventListener("resize",o))}cleanup(){for(let e of this.cleanups)e()}setupNavigationControls(){let e=document.createElement("div");e.className="mermaid-controls";let r=this.createButton("+",()=>this.zoom(.1)),t=this.createButton("-",()=>this.zoom(-.1)),o=this.createButton("Reset",()=>this.resetTransform());e.appendChild(t),e.appendChild(o),e.appendChild(r),this.container.appendChild(e)}createButton(e,r){let t=document.createElement("button");return t.textContent=e,t.className="mermaid-control-button",t.addEventListener("click",r),window.addCleanup(()=>t.removeEventListener("click",r)),t}onMouseDown(e){e.button===0&&(this.isDragging=!0,this.startPan={x:e.clientX-this.currentPan.x,y:e.clientY-this.currentPan.y},this.container.style.cursor="grabbing")}onMouseMove(e){this.isDragging&&(e.preventDefault(),this.currentPan={x:e.clientX-this.startPan.x,y:e.clientY-this.startPan.y},this.updateTransform())}onMouseUp(){this.isDragging=!1,this.container.style.cursor="grab"}zoom(e){let r=Math.min(Math.max(this.scale+e,this.MIN_SCALE),this.MAX_SCALE),t=this.content.getBoundingClientRect(),o=t.width/2,n=t.height/2,c=r-this.scale;this.currentPan.x-=o*c,this.currentPan.y-=n*c,this.scale=r,this.updateTransform()}updateTransform(){this.content.style.transform=`translate(${this.currentPan.x}px, ${this.currentPan.y}px) scale(${this.scale})`}resetTransform(){this.scale=1;let e=this.content.querySelector("svg");this.currentPan={x:e.getBoundingClientRect().width/2,y:e.getBoundingClientRect().height/2},this.updateTransform()}},C=["--secondary","--tertiary","--gray","--light","--lightgray","--highlight","--dark","--darkgray","--codeFont"],E;document.addEventListener("nav",async()=>{let e=document.querySelector(".center").querySelectorAll("code.mermaid");if(e.length===0)return;E||=await import("https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.4.0/mermaid.esm.min.mjs");let r=E.default,t=new WeakMap;for(let n of e)t.set(n,n.innerText);async function o(){for(let s of e){s.removeAttribute("data-processed");let a=t.get(s);a&&(s.innerHTML=a)}let n=C.reduce((s,a)=>(s[a]=window.getComputedStyle(document.documentElement).getPropertyValue(a),s),{}),c=document.documentElement.getAttribute("saved-theme")==="dark";r.initialize({startOnLoad:!1,securityLevel:"loose",theme:c?"dark":"base",themeVariables:{fontFamily:n["--codeFont"],primaryColor:n["--light"],primaryTextColor:n["--darkgray"],primaryBorderColor:n["--tertiary"],lineColor:n["--darkgray"],secondaryColor:n["--secondary"],tertiaryColor:n["--tertiary"],clusterBkg:n["--light"],edgeLabelBackground:n["--highlight"]}}),await r.run({nodes:e})}await o(),document.addEventListener("themechange",o),window.addCleanup(()=>document.removeEventListener("themechange",o));for(let n=0;n<e.length;n++){let v=function(){let g=l.querySelector("#mermaid-space"),m=l.querySelector(".mermaid-content");if(!m)return;y(m);let w=c.querySelector("svg").cloneNode(!0);m.appendChild(w),l.classList.add("active"),g.style.cursor="grab",u=new h(g,m)},M=function(){l.classList.remove("active"),u?.cleanup(),u=null},c=e[n],s=c.parentElement,a=s.querySelector(".clipboard-button"),d=s.querySelector(".expand-button"),p=window.getComputedStyle(a),L=a.offsetWidth+parseFloat(p.marginLeft||"0")+parseFloat(p.marginRight||"0");d.style.right=`calc(${L}px + 0.3rem)`,s.prepend(d);let l=s.querySelector("#mermaid-container");if(!l)return;let u=null;d.addEventListener("click",v),f(l,M),window.addCleanup(()=>{u?.cleanup(),d.removeEventListener("click",v)})}});
</script><script src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/copy-tex.min.js" type="application/javascript"></script><script src="../postscript.js" type="module"></script></html>