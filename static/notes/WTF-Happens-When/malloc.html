<!DOCTYPE html>
<html lang="en" dir="ltr"><head><title>WTF happens when you call malloc()</title><meta charset="utf-8"/><link rel="preconnect" href="https://fonts.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com"/><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Schibsted Grotesk:wght@400;700&amp;family=Source Sans Pro:ital,wght@0,400;0,600;1,400;1,600&amp;family=IBM Plex Mono:wght@400;600&amp;display=swap"/><link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin="anonymous"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="og:site_name" content="Tham Le's Notes"/><meta property="og:title" content="WTF happens when you call malloc()"/><meta property="og:type" content="website"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:title" content="WTF happens when you call malloc()"/><meta name="twitter:description" content="Complete trace of memory allocation - from malloc() to kernel, heap management, and physical memory"/><meta property="og:description" content="Complete trace of memory allocation - from malloc() to kernel, heap management, and physical memory"/><meta property="og:image:alt" content="Complete trace of memory allocation - from malloc() to kernel, heap management, and physical memory"/><meta property="og:image" content="https://notes.thamle.live/static/og-image.png"/><meta property="og:image:url" content="https://notes.thamle.live/static/og-image.png"/><meta name="twitter:image" content="https://notes.thamle.live/static/og-image.png"/><meta property="og:image:type" content="image/.png"/><meta property="twitter:domain" content="notes.thamle.live"/><meta property="og:url" content="https://notes.thamle.live/WTF-Happens-When/malloc"/><meta property="twitter:url" content="https://notes.thamle.live/WTF-Happens-When/malloc"/><link rel="icon" href="../static/icon.png"/><meta name="description" content="Complete trace of memory allocation - from malloc() to kernel, heap management, and physical memory"/><meta name="generator" content="Quartz"/><link href="../index.css" rel="stylesheet" type="text/css" spa-preserve/><style>.expand-button {
  position: absolute;
  display: flex;
  float: right;
  padding: 0.4rem;
  margin: 0.3rem;
  right: 0;
  color: var(--gray);
  border-color: var(--dark);
  background-color: var(--light);
  border: 1px solid;
  border-radius: 5px;
  opacity: 0;
  transition: 0.2s;
}
.expand-button > svg {
  fill: var(--light);
  filter: contrast(0.3);
}
.expand-button:hover {
  cursor: pointer;
  border-color: var(--secondary);
}
.expand-button:focus {
  outline: 0;
}

pre:hover > .expand-button {
  opacity: 1;
  transition: 0.2s;
}

#mermaid-container {
  position: fixed;
  contain: layout;
  z-index: 999;
  left: 0;
  top: 0;
  width: 100vw;
  height: 100vh;
  overflow: hidden;
  display: none;
  backdrop-filter: blur(4px);
  background: rgba(0, 0, 0, 0.5);
}
#mermaid-container.active {
  display: inline-block;
}
#mermaid-container > #mermaid-space {
  border: 1px solid var(--lightgray);
  background-color: var(--light);
  border-radius: 5px;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  height: 80vh;
  width: 80vw;
  overflow: hidden;
}
#mermaid-container > #mermaid-space > .mermaid-content {
  padding: 2rem;
  position: relative;
  transform-origin: 0 0;
  transition: transform 0.1s ease;
  overflow: visible;
  min-height: 200px;
  min-width: 200px;
}
#mermaid-container > #mermaid-space > .mermaid-content pre {
  margin: 0;
  border: none;
}
#mermaid-container > #mermaid-space > .mermaid-content svg {
  max-width: none;
  height: auto;
}
#mermaid-container > #mermaid-space > .mermaid-controls {
  position: absolute;
  bottom: 20px;
  right: 20px;
  display: flex;
  gap: 8px;
  padding: 8px;
  background: var(--light);
  border: 1px solid var(--lightgray);
  border-radius: 6px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  z-index: 2;
}
#mermaid-container > #mermaid-space > .mermaid-controls .mermaid-control-button {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
  padding: 0;
  border: 1px solid var(--lightgray);
  background: var(--light);
  color: var(--dark);
  border-radius: 4px;
  cursor: pointer;
  font-size: 16px;
  font-family: var(--bodyFont);
  transition: all 0.2s ease;
}
#mermaid-container > #mermaid-space > .mermaid-controls .mermaid-control-button:hover {
  background: var(--lightgray);
}
#mermaid-container > #mermaid-space > .mermaid-controls .mermaid-control-button:active {
  transform: translateY(1px);
}
#mermaid-container > #mermaid-space > .mermaid-controls .mermaid-control-button:nth-child(2) {
  width: auto;
  padding: 0 12px;
  font-size: 14px;
}
/*# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VSb290IjoiL2hvbWUvcnVubmVyL3dvcmsvbXktbm90ZXMvbXktbm90ZXMvcXVhcnR6L2NvbXBvbmVudHMvc3R5bGVzIiwic291cmNlcyI6WyJtZXJtYWlkLmlubGluZS5zY3NzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0VBQ0U7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7O0FBRUE7RUFDRTtFQUNBOztBQUdGO0VBQ0U7RUFDQTs7QUFHRjtFQUNFOzs7QUFLRjtFQUNFO0VBQ0E7OztBQUlKO0VBQ0U7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTs7QUFFQTtFQUNFOztBQUdGO0VBQ0U7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7O0FBRUE7RUFDRTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTs7QUFFQTtFQUNFO0VBQ0E7O0FBR0Y7RUFDRTtFQUNBOztBQUlKO0VBQ0U7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTs7QUFFQTtFQUNFO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7O0FBRUE7RUFDRTs7QUFHRjtFQUNFOztBQUlGO0VBQ0U7RUFDQTtFQUNBIiwic291cmNlc0NvbnRlbnQiOlsiLmV4cGFuZC1idXR0b24ge1xuICBwb3NpdGlvbjogYWJzb2x1dGU7XG4gIGRpc3BsYXk6IGZsZXg7XG4gIGZsb2F0OiByaWdodDtcbiAgcGFkZGluZzogMC40cmVtO1xuICBtYXJnaW46IDAuM3JlbTtcbiAgcmlnaHQ6IDA7IC8vIE5PVEU6IHJpZ2h0IHdpbGwgYmUgc2V0IGluIG1lcm1haWQuaW5saW5lLnRzXG4gIGNvbG9yOiB2YXIoLS1ncmF5KTtcbiAgYm9yZGVyLWNvbG9yOiB2YXIoLS1kYXJrKTtcbiAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tbGlnaHQpO1xuICBib3JkZXI6IDFweCBzb2xpZDtcbiAgYm9yZGVyLXJhZGl1czogNXB4O1xuICBvcGFjaXR5OiAwO1xuICB0cmFuc2l0aW9uOiAwLjJzO1xuXG4gICYgPiBzdmcge1xuICAgIGZpbGw6IHZhcigtLWxpZ2h0KTtcbiAgICBmaWx0ZXI6IGNvbnRyYXN0KDAuMyk7XG4gIH1cblxuICAmOmhvdmVyIHtcbiAgICBjdXJzb3I6IHBvaW50ZXI7XG4gICAgYm9yZGVyLWNvbG9yOiB2YXIoLS1zZWNvbmRhcnkpO1xuICB9XG5cbiAgJjpmb2N1cyB7XG4gICAgb3V0bGluZTogMDtcbiAgfVxufVxuXG5wcmUge1xuICAmOmhvdmVyID4gLmV4cGFuZC1idXR0b24ge1xuICAgIG9wYWNpdHk6IDE7XG4gICAgdHJhbnNpdGlvbjogMC4ycztcbiAgfVxufVxuXG4jbWVybWFpZC1jb250YWluZXIge1xuICBwb3NpdGlvbjogZml4ZWQ7XG4gIGNvbnRhaW46IGxheW91dDtcbiAgei1pbmRleDogOTk5O1xuICBsZWZ0OiAwO1xuICB0b3A6IDA7XG4gIHdpZHRoOiAxMDB2dztcbiAgaGVpZ2h0OiAxMDB2aDtcbiAgb3ZlcmZsb3c6IGhpZGRlbjtcbiAgZGlzcGxheTogbm9uZTtcbiAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDRweCk7XG4gIGJhY2tncm91bmQ6IHJnYmEoMCwgMCwgMCwgMC41KTtcblxuICAmLmFjdGl2ZSB7XG4gICAgZGlzcGxheTogaW5saW5lLWJsb2NrO1xuICB9XG5cbiAgJiA+ICNtZXJtYWlkLXNwYWNlIHtcbiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1saWdodGdyYXkpO1xuICAgIGJhY2tncm91bmQtY29sb3I6IHZhcigtLWxpZ2h0KTtcbiAgICBib3JkZXItcmFkaXVzOiA1cHg7XG4gICAgcG9zaXRpb246IGZpeGVkO1xuICAgIHRvcDogNTAlO1xuICAgIGxlZnQ6IDUwJTtcbiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTtcbiAgICBoZWlnaHQ6IDgwdmg7XG4gICAgd2lkdGg6IDgwdnc7XG4gICAgb3ZlcmZsb3c6IGhpZGRlbjtcblxuICAgICYgPiAubWVybWFpZC1jb250ZW50IHtcbiAgICAgIHBhZGRpbmc6IDJyZW07XG4gICAgICBwb3NpdGlvbjogcmVsYXRpdmU7XG4gICAgICB0cmFuc2Zvcm0tb3JpZ2luOiAwIDA7XG4gICAgICB0cmFuc2l0aW9uOiB0cmFuc2Zvcm0gMC4xcyBlYXNlO1xuICAgICAgb3ZlcmZsb3c6IHZpc2libGU7XG4gICAgICBtaW4taGVpZ2h0OiAyMDBweDtcbiAgICAgIG1pbi13aWR0aDogMjAwcHg7XG5cbiAgICAgIHByZSB7XG4gICAgICAgIG1hcmdpbjogMDtcbiAgICAgICAgYm9yZGVyOiBub25lO1xuICAgICAgfVxuXG4gICAgICBzdmcge1xuICAgICAgICBtYXgtd2lkdGg6IG5vbmU7XG4gICAgICAgIGhlaWdodDogYXV0bztcbiAgICAgIH1cbiAgICB9XG5cbiAgICAmID4gLm1lcm1haWQtY29udHJvbHMge1xuICAgICAgcG9zaXRpb246IGFic29sdXRlO1xuICAgICAgYm90dG9tOiAyMHB4O1xuICAgICAgcmlnaHQ6IDIwcHg7XG4gICAgICBkaXNwbGF5OiBmbGV4O1xuICAgICAgZ2FwOiA4cHg7XG4gICAgICBwYWRkaW5nOiA4cHg7XG4gICAgICBiYWNrZ3JvdW5kOiB2YXIoLS1saWdodCk7XG4gICAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1saWdodGdyYXkpO1xuICAgICAgYm9yZGVyLXJhZGl1czogNnB4O1xuICAgICAgYm94LXNoYWRvdzogMCAycHggNHB4IHJnYmEoMCwgMCwgMCwgMC4xKTtcbiAgICAgIHotaW5kZXg6IDI7XG5cbiAgICAgIC5tZXJtYWlkLWNvbnRyb2wtYnV0dG9uIHtcbiAgICAgICAgZGlzcGxheTogZmxleDtcbiAgICAgICAgYWxpZ24taXRlbXM6IGNlbnRlcjtcbiAgICAgICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7XG4gICAgICAgIHdpZHRoOiAzMnB4O1xuICAgICAgICBoZWlnaHQ6IDMycHg7XG4gICAgICAgIHBhZGRpbmc6IDA7XG4gICAgICAgIGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWxpZ2h0Z3JheSk7XG4gICAgICAgIGJhY2tncm91bmQ6IHZhcigtLWxpZ2h0KTtcbiAgICAgICAgY29sb3I6IHZhcigtLWRhcmspO1xuICAgICAgICBib3JkZXItcmFkaXVzOiA0cHg7XG4gICAgICAgIGN1cnNvcjogcG9pbnRlcjtcbiAgICAgICAgZm9udC1zaXplOiAxNnB4O1xuICAgICAgICBmb250LWZhbWlseTogdmFyKC0tYm9keUZvbnQpO1xuICAgICAgICB0cmFuc2l0aW9uOiBhbGwgMC4ycyBlYXNlO1xuXG4gICAgICAgICY6aG92ZXIge1xuICAgICAgICAgIGJhY2tncm91bmQ6IHZhcigtLWxpZ2h0Z3JheSk7XG4gICAgICAgIH1cblxuICAgICAgICAmOmFjdGl2ZSB7XG4gICAgICAgICAgdHJhbnNmb3JtOiB0cmFuc2xhdGVZKDFweCk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBTdHlsZSB0aGUgcmVzZXQgYnV0dG9uIGRpZmZlcmVudGx5XG4gICAgICAgICY6bnRoLWNoaWxkKDIpIHtcbiAgICAgICAgICB3aWR0aDogYXV0bztcbiAgICAgICAgICBwYWRkaW5nOiAwIDEycHg7XG4gICAgICAgICAgZm9udC1zaXplOiAxNHB4O1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG59XG4iXX0= */</style><link href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" rel="stylesheet" type="text/css" spa-preserve/><script src="../prescript.js" type="application/javascript" spa-preserve></script><script type="application/javascript" spa-preserve>const fetchData = fetch("../static/contentIndex.json").then(data => data.json())</script><link rel="alternate" type="application/rss+xml" title="RSS Feed" href="https://notes.thamle.live/index.xml"/></head><body data-slug="WTF-Happens-When/malloc"><div id="quartz-root" class="page"><div id="quartz-body"><div class="left sidebar"><h2 class="page-title"><a href="..">Tham Le's Notes</a></h2><div class="spacer mobile-only"></div><div class="search"><button class="search-button"><svg role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title>Search</title><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"></path><circle cx="8" cy="8" r="7"></circle></g></svg><p>Search</p></button><div class="search-container"><div class="search-space"><input autocomplete="off" class="search-bar" name="search" type="text" aria-label="Search for something" placeholder="Search for something"/><div class="search-layout" data-preview="true"></div></div></div></div><button class="darkmode"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" class="dayIcon" x="0px" y="0px" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35" xml:space="preserve" aria-label="Dark mode"><title>Dark mode</title><path d="M6,17.5C6,16.672,5.328,16,4.5,16h-3C0.672,16,0,16.672,0,17.5    S0.672,19,1.5,19h3C5.328,19,6,18.328,6,17.5z M7.5,26c-0.414,0-0.789,0.168-1.061,0.439l-2,2C4.168,28.711,4,29.086,4,29.5    C4,30.328,4.671,31,5.5,31c0.414,0,0.789-0.168,1.06-0.44l2-2C8.832,28.289,9,27.914,9,27.5C9,26.672,8.329,26,7.5,26z M17.5,6    C18.329,6,19,5.328,19,4.5v-3C19,0.672,18.329,0,17.5,0S16,0.672,16,1.5v3C16,5.328,16.671,6,17.5,6z M27.5,9    c0.414,0,0.789-0.168,1.06-0.439l2-2C30.832,6.289,31,5.914,31,5.5C31,4.672,30.329,4,29.5,4c-0.414,0-0.789,0.168-1.061,0.44    l-2,2C26.168,6.711,26,7.086,26,7.5C26,8.328,26.671,9,27.5,9z M6.439,8.561C6.711,8.832,7.086,9,7.5,9C8.328,9,9,8.328,9,7.5    c0-0.414-0.168-0.789-0.439-1.061l-2-2C6.289,4.168,5.914,4,5.5,4C4.672,4,4,4.672,4,5.5c0,0.414,0.168,0.789,0.439,1.06    L6.439,8.561z M33.5,16h-3c-0.828,0-1.5,0.672-1.5,1.5s0.672,1.5,1.5,1.5h3c0.828,0,1.5-0.672,1.5-1.5S34.328,16,33.5,16z     M28.561,26.439C28.289,26.168,27.914,26,27.5,26c-0.828,0-1.5,0.672-1.5,1.5c0,0.414,0.168,0.789,0.439,1.06l2,2    C28.711,30.832,29.086,31,29.5,31c0.828,0,1.5-0.672,1.5-1.5c0-0.414-0.168-0.789-0.439-1.061L28.561,26.439z M17.5,29    c-0.829,0-1.5,0.672-1.5,1.5v3c0,0.828,0.671,1.5,1.5,1.5s1.5-0.672,1.5-1.5v-3C19,29.672,18.329,29,17.5,29z M17.5,7    C11.71,7,7,11.71,7,17.5S11.71,28,17.5,28S28,23.29,28,17.5S23.29,7,17.5,7z M17.5,25c-4.136,0-7.5-3.364-7.5-7.5    c0-4.136,3.364-7.5,7.5-7.5c4.136,0,7.5,3.364,7.5,7.5C25,21.636,21.636,25,17.5,25z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" class="nightIcon" x="0px" y="0px" viewBox="0 0 100 100" style="enable-background:new 0 0 100 100" xml:space="preserve" aria-label="Light mode"><title>Light mode</title><path d="M96.76,66.458c-0.853-0.852-2.15-1.064-3.23-0.534c-6.063,2.991-12.858,4.571-19.655,4.571  C62.022,70.495,50.88,65.88,42.5,57.5C29.043,44.043,25.658,23.536,34.076,6.47c0.532-1.08,0.318-2.379-0.534-3.23  c-0.851-0.852-2.15-1.064-3.23-0.534c-4.918,2.427-9.375,5.619-13.246,9.491c-9.447,9.447-14.65,22.008-14.65,35.369  c0,13.36,5.203,25.921,14.65,35.368s22.008,14.65,35.368,14.65c13.361,0,25.921-5.203,35.369-14.65  c3.872-3.871,7.064-8.328,9.491-13.246C97.826,68.608,97.611,67.309,96.76,66.458z"></path></svg></button><div class="explorer desktop-only" data-behavior="link" data-collapsed="collapsed" data-savestate="true" data-data-fns="{&quot;order&quot;:[&quot;filter&quot;,&quot;map&quot;,&quot;sort&quot;],&quot;sortFn&quot;:&quot;(a,b)=>!a.isFolder&amp;&amp;!b.isFolder||a.isFolder&amp;&amp;b.isFolder?a.displayName.localeCompare(b.displayName,void 0,{numeric:!0,sensitivity:\&quot;base\&quot;}):!a.isFolder&amp;&amp;b.isFolder?1:-1&quot;,&quot;filterFn&quot;:&quot;node=>node.slugSegment!==\&quot;tags\&quot;&quot;,&quot;mapFn&quot;:&quot;node=>node&quot;}"><button type="button" class="explorer-toggle mobile-explorer hide-until-loaded" data-mobile="true" aria-controls="explorer-266"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide-menu"><line x1="4" x2="20" y1="12" y2="12"></line><line x1="4" x2="20" y1="6" y2="6"></line><line x1="4" x2="20" y1="18" y2="18"></line></svg></button><button type="button" class="title-button explorer-toggle desktop-explorer" data-mobile="false" aria-expanded="true"><h2>Explorer</h2><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="fold"><polyline points="6 9 12 15 18 9"></polyline></svg></button><div id="explorer-266" class="explorer-content" aria-expanded="false" role="group"><ul class="explorer-ul overflow" id="list-0"><li class="overflow-end"></li></ul></div><template id="template-file"><li><a href="#"></a></li></template><template id="template-folder"><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div><button class="folder-button"><span class="folder-title"></span></button></div></div><div class="folder-outer"><ul class="content"></ul></div></li></template></div></div><div class="center"><div class="page-header"><div class="popover-hint"><nav class="breadcrumb-container" aria-label="breadcrumbs"><div class="breadcrumb-element"><a href="../">Home</a><p> ❯ </p></div><div class="breadcrumb-element"><a href="../WTF-Happens-When/">WTF Happens When</a><p> ❯ </p></div><div class="breadcrumb-element"><a href>WTF happens when you call malloc()</a></div></nav><h1 class="article-title">WTF happens when you call malloc()</h1><p show-comma="true" class="content-meta"><time datetime="2025-11-07T00:00:00.000Z">Nov 07, 2025</time><span>13 min read</span></p><ul class="tags"><li><a href="../tags/memory" class="internal tag-link">memory</a></li><li><a href="../tags/heap" class="internal tag-link">heap</a></li><li><a href="../tags/systems" class="internal tag-link">systems</a></li><li><a href="../tags/deep-dive" class="internal tag-link">deep-dive</a></li></ul></div></div><article class="popover-hint"><h1 id="wtf-happens-when-you-call-malloc">WTF happens when you call <code>malloc()</code><a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#wtf-happens-when-you-call-malloc" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h1>
<p>You write <code>ptr = malloc(1024);</code> and get back a pointer. <strong>WTF just happened?</strong></p>
<p>Let’s trace through <strong>every single step</strong> from your C code to physical RAM allocation.</p>
<hr/>
<h2 id="table-of-contents">Table of Contents<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#table-of-contents" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<ol>
<li><a href="#1-you-call-malloc" class="internal alias">You call malloc()</a></li>
<li><a href="#2-small-allocation--128kb" class="internal alias">Small allocation (&lt; 128KB)</a></li>
<li><a href="#3-large-allocation--128kb" class="internal alias">Large allocation (≥ 128KB)</a></li>
<li><a href="#4-system-calls-brk-vs-mmap" class="internal alias">System calls: brk() vs mmap()</a></li>
<li><a href="#5-kernel-allocates-virtual-memory" class="internal alias">Kernel allocates virtual memory</a></li>
<li><a href="#6-physical-memory-allocation-demand-paging" class="internal alias">Physical memory allocation (demand paging)</a></li>
<li><a href="#7-you-write-to-the-memory" class="internal alias">You write to the memory</a></li>
<li><a href="#8-you-call-free" class="internal alias">You call free()</a></li>
<li><a href="#9-memory-allocator-internals" class="internal alias">Memory allocator internals</a></li>
<li><a href="#10-complete-timeline" class="internal alias">Complete timeline</a></li>
</ol>
<hr/>
<h2 id="1-you-call-malloc">1. You call malloc()<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#1-you-call-malloc" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<h3 id="your-c-code">Your C code<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#your-c-code" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="c" data-theme="github-light github-dark"><code data-language="c" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &lt;stdlib.h></span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    char</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ptr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> malloc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1024</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Allocate 1KB</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (ptr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // Out of memory!</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Use the memory...</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    strcpy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ptr, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Hello, world!&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    free</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ptr);</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></figure>
<p><strong>Simple API:</strong></p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="c" data-theme="github-light github-dark"><code data-language="c" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">malloc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">size_t</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> size</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Allocate size bytes</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> free</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // Free previously allocated memory</span></span></code></pre></figure>
<p><strong>See:</strong> <a href="../Memory-Allocation" class="internal" data-slug="Memory-Allocation">Memory-Allocation</a></p>
<h3 id="what-malloc-is-not">What malloc() is NOT<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#what-malloc-is-not" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p><strong>Common misconceptions:</strong></p>
<ol>
<li>
<p>❌ <code>malloc()</code> is NOT a system call</p>
<ul>
<li>It’s a C library function (in <code>libc.so</code>)</li>
</ul>
</li>
<li>
<p>❌ <code>malloc()</code> does NOT always ask the kernel for memory</p>
<ul>
<li>It manages a memory pool (the heap)</li>
</ul>
</li>
<li>
<p>❌ <code>malloc()</code> does NOT zero memory</p>
<ul>
<li>Memory contains garbage (use <code>calloc()</code> for zeroed memory)</li>
</ul>
</li>
</ol>
<p><strong>What malloc() actually does:</strong></p>
<ol>
<li><strong>Checks size:</strong> Is it small (&lt;128KB) or large?</li>
<li><strong>Looks in free lists:</strong> Do we have a free block?</li>
<li><strong>If yes:</strong> Return that block</li>
<li><strong>If no:</strong> Ask kernel for more memory (via <code>brk()</code> or <code>mmap()</code>)</li>
<li><strong>Split/coalesce</strong> blocks as needed</li>
<li><strong>Return pointer</strong> to usable memory</li>
</ol>
<p>Let’s trace through both cases…</p>
<hr/>
<h2 id="2-small-allocation--128kb">2. Small allocation (&lt; 128KB)<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#2-small-allocation--128kb" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>For allocations under 128KB, malloc uses the <strong>heap</strong> (managed via <code>brk()</code>).</p>
<h3 id="heap-structure">Heap structure<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#heap-structure" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p><strong>The heap is a contiguous region</strong> that grows upward:</p>
<pre><code>Low addresses
    ↓
[Text Segment]     ← Your code
[Data Segment]     ← Global variables
[BSS Segment]      ← Uninitialized globals
[Heap] ← Grows upward ↑
  ...
  (unmapped gap)
  ...
[Stack] ← Grows downward ↓
    ↓
High addresses
</code></pre>
<p><strong>The heap grows from <code>program_break</code> (initially after BSS).</strong></p>
<p><strong>See:</strong> <a href="../Virtual-Memory" class="internal" data-slug="Virtual-Memory">Virtual-Memory</a>, <a href="../Heap" class="internal" data-slug="Heap">Heap</a></p>
<h3 id="malloc-internal-structures-ptmalloc2">malloc() internal structures (ptmalloc2)<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#malloc-internal-structures-ptmalloc2" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p><strong>Glibc uses ptmalloc2</strong> (Doug Lea’s malloc + multithreading).</p>
<p><strong>Each allocated block has metadata:</strong></p>
<pre><code>┌──────────────────┐
│ Size | Flags     │  ← Metadata (8 bytes)
├──────────────────┤
│                  │
│  User Data       │  ← Returned to user
│  (1024 bytes)    │
│                  │
└──────────────────┘
</code></pre>
<p><strong>Flags:</strong></p>
<ul>
<li><code>PREV_INUSE</code> (bit 0): Is previous block in use?</li>
<li><code>IS_MMAPPED</code> (bit 1): Allocated via mmap?</li>
<li><code>NON_MAIN_ARENA</code> (bit 2): Not in main arena</li>
</ul>
<p><strong>Size includes metadata!</strong> If you ask for 1024 bytes, malloc rounds up and adds overhead.</p>
<h3 id="size-classes-and-bins">Size classes and bins<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#size-classes-and-bins" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p>malloc organizes free blocks into <strong>bins</strong> by size:</p>
<p><strong>Fast bins (LIFO, no coalescing):</strong></p>
<pre><code>Size 16, 24, 32, 40, 48, 56, 64, 72, 80 bytes
</code></pre>
<p><strong>Small bins (FIFO, exact size):</strong></p>
<pre><code>Size 16, 24, 32, ..., 504, 512 bytes
</code></pre>
<p><strong>Large bins (sorted by size):</strong></p>
<pre><code>Size ≥ 512 bytes
</code></pre>
<p><strong>Unsorted bin:</strong></p>
<ul>
<li>Recently freed chunks (cache for quick reallocation)</li>
</ul>
<h3 id="malloc1024-walkthrough">malloc(1024) walkthrough<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#malloc1024-walkthrough" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p><strong>Step 1: Check fast bins</strong></p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="c" data-theme="github-light github-dark"><code data-language="c" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 1024 bytes is too large for fast bins (max 80)</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Skip fast bins</span></span></code></pre></figure>
<p><strong>Step 2: Check small bins</strong></p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="c" data-theme="github-light github-dark"><code data-language="c" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 1024 bytes is too large for small bins (max 512)</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Skip small bins</span></span></code></pre></figure>
<p><strong>Step 3: Check unsorted bin</strong></p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="c" data-theme="github-light github-dark"><code data-language="c" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Look for recently freed block of size ≥ 1024</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (found_in_unsorted_bin) {</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    split_chunk_if_needed</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> chunk;</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></figure>
<p><strong>Step 4: Check large bins</strong></p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="c" data-theme="github-light github-dark"><code data-language="c" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Look for best-fit block in large bins</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (found_in_large_bins) {</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    split_chunk_if_needed</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> chunk;</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></figure>
<p><strong>Step 5: Extend heap</strong></p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="c" data-theme="github-light github-dark"><code data-language="c" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// No suitable free block found</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Need to get more memory from OS</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (heap_can_grow) {</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    sbrk</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(size);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Move program break upward</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    create_new_chunk</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> chunk;</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></figure>
<p><strong>See:</strong> <a href="../Heap" class="internal" data-slug="Heap">Heap</a>, <a href="../Memory-Allocator" class="internal" data-slug="Memory-Allocator">Memory-Allocator</a></p>
<h3 id="splitting-chunks">Splitting chunks<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#splitting-chunks" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p>If malloc finds a 4096-byte block but you only need 1024:</p>
<pre><code>Before:
┌────────────────────────────────┐
│ Free block (4096 bytes)        │
└────────────────────────────────┘

After:
┌──────────────────┐┌────────────┐
│ Used (1024 bytes)││ Free (3072)│
└──────────────────┘└────────────┘
                      ↑
                  Add to free list
</code></pre>
<p>This minimizes waste.</p>
<hr/>
<h2 id="3-large-allocation--128kb">3. Large allocation (≥ 128KB)<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#3-large-allocation--128kb" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>For large allocations, malloc uses <code>mmap()</code> instead of the heap.</p>
<p><strong>Why?</strong></p>
<ul>
<li>Heap fragmentation for large blocks is wasteful</li>
<li><code>mmap()</code> can be freed directly to OS (no permanent heap growth)</li>
<li><code>mmap()</code> regions are independent (isolated)</li>
</ul>
<h3 id="malloc200000-using-mmap">malloc(200000) using mmap<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#malloc200000-using-mmap" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="c" data-theme="github-light github-dark"><code data-language="c" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">char</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ptr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> malloc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">200000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 200KB > 128KB threshold</span></span></code></pre></figure>
<p><strong>malloc() calls mmap:</strong></p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="c" data-theme="github-light github-dark"><code data-language="c" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">addr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> mmap</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, size, PROT_READ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PROT_WRITE,</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                  MAP_PRIVATE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> MAP_ANONYMOUS, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></figure>
<p><strong>What mmap does:</strong></p>
<ol>
<li>Finds unused region in virtual address space</li>
<li>Creates new VMA (Virtual Memory Area) in kernel</li>
<li>Maps it as anonymous (not backed by file)</li>
<li>Returns virtual address</li>
</ol>
<p><strong>Memory is NOT yet backed by physical RAM!</strong></p>
<p><strong>See:</strong> <a href="../mmap" class="internal" data-slug="mmap">mmap</a>, <a href="../Virtual-Memory" class="internal" data-slug="Virtual-Memory">Virtual-Memory</a></p>
<h3 id="memory-layout-with-mmap-allocations">Memory layout with mmap allocations<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#memory-layout-with-mmap-allocations" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<pre><code>[Heap] ← brk-based allocations
  ...
  (unmapped)
  ...
[mmap region 1] ← Large allocation #1
  (unmapped)
[mmap region 2] ← Large allocation #2
  (unmapped)
[mmap region 3] ← Shared library
  ...
[Stack]
</code></pre>
<p><strong>mmap regions are scattered</strong> (kernel picks addresses).</p>
<p><strong>Advantage:</strong> Freeing an mmap region returns memory to OS immediately.</p>
<hr/>
<h2 id="4-system-calls-brk-vs-mmap">4. System calls: brk() vs mmap()<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#4-system-calls-brk-vs-mmap" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<h3 id="brk--sbrk">brk() / sbrk()<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#brk--sbrk" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p><strong>Changes the program break</strong> (end of heap).</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="c" data-theme="github-light github-dark"><code data-language="c" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Get current break</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">old_brk </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sbrk</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Increase heap by 4096 bytes</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">new_brk </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sbrk</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4096</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// new_brk == old_brk (returns old break)</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Heap now 4096 bytes larger</span></span></code></pre></figure>
<p><strong>In the kernel:</strong></p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="c" data-theme="github-light github-dark"><code data-language="c" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sys_brk</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> brk</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Check if new_brk is valid</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (brk </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mm->start_brk </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> brk </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">></span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mm->end_data </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rlimit) {</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ENOMEM;</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Update mm->brk</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    mm->brk </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> brk;</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Map new pages if needed</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (brk </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">></span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> old_brk) {</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        do_brk</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(old_brk, brk </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> old_brk);</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></figure>
<p><strong>Limitations:</strong></p>
<ul>
<li>❌ Heap is contiguous (can’t shrink middle)</li>
<li>❌ Free in middle doesn’t return memory to OS</li>
<li>❌ Heap fragmentation is permanent</li>
</ul>
<p><strong>See:</strong> <a href="../System-Call" class="internal" data-slug="System-Call">System-Call</a></p>
<h3 id="mmap">mmap()<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#mmap" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p><strong>Maps a region</strong> of virtual memory.</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="c" data-theme="github-light github-dark"><code data-language="c" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">addr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> mmap</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                   // Let kernel choose address</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    size,</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                   // Size in bytes</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    PROT_READ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PROT_WRITE,</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // Permissions</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    MAP_PRIVATE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> MAP_ANONYMOUS,</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // Private, not file-backed</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                     // No file descriptor</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    0</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                       // Offset (ignored)</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></figure>
<p><strong>In the kernel:</strong></p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="c" data-theme="github-light github-dark"><code data-language="c" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sys_mmap</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(...) {</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Find unused region in address space</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    addr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> find_vma_gap</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(size);</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Create VMA (Virtual Memory Area)</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    vma </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> kmalloc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> vm_area_struct));</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    vma->vm_start </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> addr;</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    vma->vm_end </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> addr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> size;</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    vma->vm_flags </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> VM_READ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> VM_WRITE;</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Add to process's VMA list</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    insert_vm_struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(current->mm, vma);</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> addr;</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></figure>
<p><strong>Advantages:</strong></p>
<ul>
<li>✅ Can free independent regions</li>
<li>✅ No heap fragmentation</li>
<li>✅ Can set specific permissions</li>
</ul>
<p><strong>See:</strong> <a href="../mmap" class="internal" data-slug="mmap">mmap</a></p>
<hr/>
<h2 id="5-kernel-allocates-virtual-memory">5. Kernel allocates virtual memory<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#5-kernel-allocates-virtual-memory" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>When malloc calls <code>brk()</code> or <code>mmap()</code>, <strong>kernel allocates virtual memory</strong> (not physical!).</p>
<h3 id="virtual-memory-area-vma">Virtual Memory Area (VMA)<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#virtual-memory-area-vma" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p><strong>Kernel tracks each memory region:</strong></p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="c" data-theme="github-light github-dark"><code data-language="c" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> vm_area_struct {</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> vm_start;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // Start address</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> vm_end;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     // End address</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> vm_flags;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // Permissions (read/write/exec)</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> file </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">vm_file;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     // Backing file (NULL for anonymous)</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ...</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre></figure>
<p><strong>Process’s memory map:</strong></p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cat /proc/self/maps</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">00400000-00401000</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> r-xp </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">00000000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 08</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">:01 </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">12345</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /bin/program  </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">text</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">00601000-00602000</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rw-p </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">00001000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 08</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">:01 </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">12345</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /bin/program  </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">00602000-00623000</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rw-p </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">00000000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 00</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">:00 </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     [heap]</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">7f1234567000-7f1234568000</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rw-p </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">00000000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 00</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">:00 </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mmap</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">7f9876543000-7f9876544000</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rw-p </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">00000000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 00</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">:00 </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  [stack]</span></span></code></pre></figure>
<p><strong>Each line is a VMA.</strong></p>
<p><strong>See:</strong> <a href="../Virtual-Memory" class="internal" data-slug="Virtual-Memory">Virtual-Memory</a>, <a href="../VMA" class="internal" data-slug="VMA">VMA</a></p>
<h3 id="page-tables">Page tables<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#page-tables" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p><strong>Virtual addresses must be mapped</strong> to physical addresses.</p>
<p><strong>Page table structure (x86-64):</strong></p>
<pre><code>Virtual Address (48 bits):
┌────────┬────────┬────────┬────────┬──────────────┐
│ PML4   │ PDPT   │ PD     │ PT     │ Offset       │
│ (9bit) │ (9bit) │ (9bit) │ (9bit) │ (12bit)      │
└────────┴────────┴────────┴────────┴──────────────┘
   ↓        ↓        ↓        ↓           ↓
  PML4 → PDPT → PD → PT → Physical Page
</code></pre>
<p><strong>4-level page table:</strong></p>
<pre><code>CR3 register → PML4 table
               ├─ PDPT
               │  ├─ Page Directory
               │  │  ├─ Page Table
               │  │  │  ├─ Page 0 → Physical Frame
               │  │  │  ├─ Page 1 → Physical Frame
               │  │  │  └─ ...
</code></pre>
<p><strong>Initially, malloc’d pages are NOT in page table</strong> (no physical memory allocated).</p>
<p><strong>See:</strong> <a href="../Page-Table" class="internal" data-slug="Page-Table">Page-Table</a></p>
<hr/>
<h2 id="6-physical-memory-allocation-demand-paging">6. Physical memory allocation (demand paging)<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#6-physical-memory-allocation-demand-paging" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>When you <strong>first access</strong> malloc’d memory, a <strong>page fault</strong> occurs.</p>
<h3 id="page-fault-flow">Page fault flow<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#page-fault-flow" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p><strong>You write to malloc’d memory:</strong></p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="c" data-theme="github-light github-dark"><code data-language="c" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">char</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ptr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> malloc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1024</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span data-line><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 'A'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Page fault!</span></span></code></pre></figure>
<p><strong>What happens:</strong></p>
<ol>
<li><strong>CPU tries to translate virtual address</strong></li>
<li><strong>Page table entry is empty</strong> (not present)</li>
<li><strong>CPU generates page fault exception</strong></li>
<li><strong>Kernel page fault handler runs:</strong></li>
</ol>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="c" data-theme="github-light github-dark"><code data-language="c" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">do_page_fault</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(address) {</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Find VMA containing address</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    vma </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> find_vma</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(current->mm, address);</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">vma </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> address </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> vma->vm_start) {</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // Segmentation fault!</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        send_signal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(SIGSEGV);</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Check permissions</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(vma->vm_flags </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> VM_WRITE)) {</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // Write to read-only page!</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        send_signal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(SIGSEGV);</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Allocate physical page</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    page </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> alloc_page</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(GFP_KERNEL);</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Zero the page (security: don't leak old data)</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    clear_page</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(page);</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Update page table</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    set_pte</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(page_table, address, page);</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Return to user mode</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Instruction is retried (now succeeds)</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></figure>
<p><strong>Now the page table entry points to physical RAM.</strong></p>
<p><strong>See:</strong> <a href="../Page-Fault" class="internal" data-slug="Page-Fault">Page-Fault</a>, <a href="../Demand-Paging" class="internal" data-slug="Demand-Paging">Demand-Paging</a></p>
<h3 id="buddy-allocator-kernels-physical-memory-allocator">Buddy allocator (kernel’s physical memory allocator)<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#buddy-allocator-kernels-physical-memory-allocator" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p><strong>Kernel uses buddy allocator</strong> to manage physical RAM.</p>
<p><strong>Sizes are powers of 2:</strong> 4KB, 8KB, 16KB, 32KB, …, 4MB</p>
<p><strong>Allocation:</strong></p>
<pre><code>Request 16KB:
1. Look in 16KB free list
2. If empty, split 32KB block → two 16KB blocks
3. If no 32KB, split 64KB → two 32KB, then split one 32KB
4. Return one 16KB block, add buddy to free list
</code></pre>
<p><strong>Deallocation:</strong></p>
<pre><code>Free 16KB block:
1. Check if buddy is also free
2. If yes, coalesce into 32KB block
3. Repeat recursively
4. Add to appropriate free list
</code></pre>
<p><strong>Prevents fragmentation</strong> (to some extent).</p>
<p><strong>See:</strong> <a href="../Buddy-Allocator" class="internal" data-slug="Buddy-Allocator">Buddy-Allocator</a></p>
<hr/>
<h2 id="7-you-write-to-the-memory">7. You write to the memory<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#7-you-write-to-the-memory" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>Now you can use the memory!</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="c" data-theme="github-light github-dark"><code data-language="c" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">strcpy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ptr, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Hello, world!&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></figure>
<p><strong>Each byte written:</strong></p>
<ol>
<li><strong>CPU translates virtual address</strong> (using TLB/page tables)</li>
<li><strong>Finds physical address</strong></li>
<li><strong>Writes to physical RAM</strong></li>
</ol>
<p><strong>TLB (Translation Lookaside Buffer):</strong></p>
<ul>
<li>Cache for page table entries</li>
<li>Avoids walking 4-level page table on every access</li>
<li>~100 entries, ~1 cycle lookup</li>
</ul>
<p><strong>Without TLB:</strong> Every memory access = 5 memory accesses (4 page table levels + data)</p>
<p><strong>With TLB:</strong> Every memory access = 1 memory access (if TLB hit)</p>
<p><strong>TLB hit rate:</strong> ~99% for typical programs</p>
<p><strong>See:</strong> <a href="../TLB" class="internal" data-slug="TLB">TLB</a>, <a href="../Virtual-Memory" class="internal" data-slug="Virtual-Memory">Virtual-Memory</a></p>
<hr/>
<h2 id="8-you-call-free">8. You call free()<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#8-you-call-free" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="c" data-theme="github-light github-dark"><code data-language="c" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">free</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ptr);</span></span></code></pre></figure>
<p><strong>What free() does:</strong></p>
<h3 id="small-allocation-heap">Small allocation (heap)<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#small-allocation-heap" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="c" data-theme="github-light github-dark"><code data-language="c" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">free</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ptr) {</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Get chunk metadata (8 bytes before ptr)</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    chunk </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ptr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 8</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Mark chunk as free</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    chunk->size </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">PREV_INUSE;</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Coalesce with adjacent free chunks</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (next_chunk_is_free) {</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        merge</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(chunk, next_chunk);</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (prev_chunk_is_free) {</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        merge</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(prev_chunk, chunk);</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Add to appropriate bin</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    add_to_free_list</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(chunk);</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></figure>
<p><strong>Memory is NOT returned to OS</strong> (heap can’t shrink middle).</p>
<p><strong>Memory is reused</strong> for future malloc() calls.</p>
<p><strong>See:</strong> <a href="../Memory-Allocator" class="internal" data-slug="Memory-Allocator">Memory-Allocator</a></p>
<h3 id="large-allocation-mmap">Large allocation (mmap)<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#large-allocation-mmap" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="c" data-theme="github-light github-dark"><code data-language="c" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">free</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ptr) {</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Check if allocated via mmap (flag in metadata)</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (chunk->size </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> IS_MMAPPED) {</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        munmap</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ptr, size);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Return to OS immediately</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></figure>
<p><strong>munmap() system call:</strong></p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="c" data-theme="github-light github-dark"><code data-language="c" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sys_munmap</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(addr, size) {</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Find VMA</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    vma </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> find_vma</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(mm, addr);</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Remove VMA</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    remove_vm_struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(mm, vma);</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Free page table entries</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    unmap_page_range</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(addr, addr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> size);</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Free physical pages</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    free_pages</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(vma->vm_start, vma->vm_end);</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></figure>
<p><strong>Physical memory is freed</strong> and can be used by other processes.</p>
<p><strong>See:</strong> <a href="../munmap" class="internal" data-slug="munmap">munmap</a></p>
<hr/>
<h2 id="9-memory-allocator-internals">9. Memory allocator internals<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#9-memory-allocator-internals" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<h3 id="different-allocators">Different allocators<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#different-allocators" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p><strong>glibc (ptmalloc2):</strong></p>
<ul>
<li>Default on Linux</li>
<li>Good general-purpose performance</li>
<li>Multithreading support (multiple arenas)</li>
</ul>
<p><strong>jemalloc:</strong></p>
<ul>
<li>Used by Firefox, Redis, FreeBSD</li>
<li>Better multithreaded performance</li>
<li>Less fragmentation</li>
</ul>
<p><strong>tcmalloc (Google):</strong></p>
<ul>
<li>Used by Chrome</li>
<li>Per-thread caches (no lock contention)</li>
<li>Very fast for multithreaded workloads</li>
</ul>
<p><strong>mimalloc (Microsoft):</strong></p>
<ul>
<li>Modern allocator</li>
<li>Excellent security features</li>
<li>Good performance</li>
</ul>
<p><strong>See:</strong> <a href="../Memory-Allocator" class="internal" data-slug="Memory-Allocator">Memory-Allocator</a></p>
<h3 id="multithreading-challenges">Multithreading challenges<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#multithreading-challenges" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p><strong>Problem:</strong> Multiple threads calling malloc() simultaneously.</p>
<p><strong>Naive solution:</strong> One global lock</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="c" data-theme="github-light github-dark"><code data-language="c" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pthread_mutex_lock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">heap_lock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ptr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> malloc_internal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(size);</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pthread_mutex_unlock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">heap_lock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></figure>
<p><strong>Problem:</strong> Lock contention (slow!)</p>
<p><strong>ptmalloc2 solution: Multiple arenas</strong></p>
<pre><code>Thread 1 → Arena 1 (separate heap)
Thread 2 → Arena 2 (separate heap)
Thread 3 → Arena 3 (separate heap)
Thread 4 → Arena 1 (reuse)
</code></pre>
<p><strong>Each arena has own lock</strong> → Less contention.</p>
<p><strong>tcmalloc solution: Thread-local caches</strong></p>
<pre><code>Thread 1 → Local cache → Central cache
Thread 2 → Local cache → Central cache
</code></pre>
<p><strong>Fast path: No locks</strong> (thread-local)
<strong>Slow path: Central cache</strong> (locked)</p>
<p><strong>See:</strong> <a href="../std-thread" class="internal" data-slug="std-thread">std-thread</a>, <a href="../Lock-Free" class="internal" data-slug="Lock-Free">Lock-Free</a></p>
<h3 id="fragmentation">Fragmentation<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#fragmentation" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p><strong>Problem:</strong> Heap becomes fragmented over time.</p>
<p><strong>Example:</strong></p>
<pre><code>Initial:
[Free: 1000000 bytes]

After many allocations:
[Used][Free:10][Used][Free:20][Used][Free:5]...

Request 100 bytes:
❌ Can't satisfy (no contiguous block)
✅ Total free: 10+20+5+... = 500 bytes
</code></pre>
<p><strong>Internal fragmentation:</strong></p>
<ul>
<li>malloc rounds up sizes</li>
<li>Metadata overhead</li>
<li>Alignment requirements</li>
</ul>
<p><strong>External fragmentation:</strong></p>
<ul>
<li>Free memory scattered in small chunks</li>
<li>Can’t satisfy large allocations</li>
</ul>
<p><strong>Solutions:</strong></p>
<ul>
<li><strong>Coalescing:</strong> Merge adjacent free blocks</li>
<li><strong>Compaction:</strong> Move allocations to defragment (not used in C)</li>
<li><strong>Size classes:</strong> Reduce fragmentation for common sizes</li>
<li><strong>mmap for large:</strong> Avoid heap fragmentation</li>
</ul>
<p><strong>See:</strong> <a href="../Fragmentation" class="internal" data-slug="Fragmentation">Fragmentation</a></p>
<hr/>
<h2 id="10-complete-timeline">10. Complete timeline<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#10-complete-timeline" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<pre><code>Time    Event
0ns     Call malloc(1024)
10ns    Check fast bins (miss)
20ns    Check small bins (miss)
30ns    Check unsorted bin (miss)
40ns    Check large bins (miss)
50ns    Need more memory from OS
60ns    Call sbrk(4096)
100ns   System call enters kernel
200ns   Kernel updates mm->brk
300ns   Kernel creates VMA
400ns   System call returns
410ns   malloc splits chunk (4096 → 1024 + 3072)
420ns   malloc returns pointer

...

500ns   Write ptr[0] = 'A'
510ns   TLB miss, walk page table
520ns   Page table entry empty → Page fault!
530ns   Kernel page fault handler
600ns   Kernel allocates physical page (buddy allocator)
650ns   Kernel zeros page
700ns   Kernel updates page table
710ns   Return to user mode
720ns   Retry write → Success!

...

1000ns  Call free(ptr)
1010ns  Mark chunk as free
1020ns  Coalesce with neighbors
1030ns  Add to free list
1040ns  Return
</code></pre>
<p><strong>Total: ~1000ns for malloc + write + free</strong> (varies widely!)</p>
<hr/>
<h2 id="key-takeaways">Key takeaways<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#key-takeaways" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<h3 id="memory-allocation-layers">Memory allocation layers<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#memory-allocation-layers" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<pre><code>Application:  malloc(size) → ptr
                  ↓
C Library:    Heap management, bins, coalescing
                  ↓
System Call:  brk()/mmap()
                  ↓
Kernel:       Virtual memory (VMAs, page tables)
                  ↓
Page Fault:   Allocate physical RAM
                  ↓
Hardware:     Physical memory (DRAM)
</code></pre>
<h3 id="fast-path-vs-slow-path">Fast path vs slow path<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#fast-path-vs-slow-path" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p><strong>Fast path (common):</strong></p>
<pre><code>malloc(32) → Fast bin → Return (10-20ns)
</code></pre>
<p><strong>Slow path (rare):</strong></p>
<pre><code>malloc(1024) → No free blocks → sbrk() → syscall → kernel (500-1000ns)
</code></pre>
<p><strong>First write:</strong></p>
<pre><code>ptr[0] = 'A' → Page fault → Allocate physical page (500-1000ns)
</code></pre>
<h3 id="performance-tips">Performance tips<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#performance-tips" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p><strong>Do:</strong></p>
<ul>
<li>✅ Reuse allocations (object pools)</li>
<li>✅ Allocate once, use many times</li>
<li>✅ Use stack when possible (faster than malloc)</li>
<li>✅ Batch allocations (allocate array instead of individual items)</li>
<li>✅ Use appropriate allocator (jemalloc for multithreaded)</li>
</ul>
<p><strong>Don’t:</strong></p>
<ul>
<li>❌ Frequent small allocations (use memory pool)</li>
<li>❌ Mix allocation sizes (causes fragmentation)</li>
<li>❌ Forget to free (memory leaks)</li>
<li>❌ Double free (undefined behavior, crash)</li>
<li>❌ Use after free (undefined behavior, security issue)</li>
</ul>
<p><strong>See:</strong> <a href="../Memory-Leak" class="internal" data-slug="Memory-Leak">Memory-Leak</a>, <a href="../Use-After-Free" class="internal" data-slug="Use-After-Free">Use-After-Free</a></p>
<hr/>
<h2 id="related-concepts">Related concepts<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#related-concepts" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<ul>
<li><a href="../Heap" class="internal" data-slug="Heap">Heap</a> - Heap memory region</li>
<li><a href="../Virtual-Memory" class="internal" data-slug="Virtual-Memory">Virtual-Memory</a> - Virtual address spaces</li>
<li><a href="../Page-Fault" class="internal" data-slug="Page-Fault">Page-Fault</a> - Demand paging</li>
<li><a href="../mmap" class="internal" data-slug="mmap">mmap</a> - Memory mapping system call</li>
<li><a href="../Memory-Allocator" class="internal" data-slug="Memory-Allocator">Memory-Allocator</a> - Allocator algorithms</li>
<li><a href="../RAII" class="internal" data-slug="RAII">RAII</a> - Automatic memory management (C++)</li>
<li><a href="../Stack" class="internal" data-slug="Stack">Stack</a> - Stack memory (alternative to heap)</li>
</ul>
<hr/>
<h2 id="further-reading">Further reading<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#further-reading" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p><strong>Books:</strong></p>
<ul>
<li>“Computer Systems: A Programmer’s Perspective” (Bryant &amp; O’Hallaron)</li>
<li>“The Linux Programming Interface” (Kerrisk)</li>
</ul>
<p><strong>See:</strong> <a href="../Book-Notes/CSAPP-Notes" class="internal" data-slug="Book-Notes/CSAPP-Notes">CSAPP-Notes</a></p>
<p><strong>Papers:</strong></p>
<ul>
<li>“Malloc Design” (Doug Lea)</li>
<li>“TCMalloc: Thread-Caching Malloc” (Google)</li>
<li>“jemalloc: A Scalable Concurrent Malloc Implementation”</li>
</ul>
<p><strong>Debugging tools:</strong></p>
<ul>
<li><strong>Valgrind:</strong> Memory leak detection</li>
<li><strong>AddressSanitizer:</strong> Use-after-free, buffer overflow</li>
<li><strong>Massif:</strong> Heap profiler</li>
</ul>
<p><strong>See:</strong> <a href="../Debugging/Valgrind-Guide" class="internal" data-slug="Debugging/Valgrind-Guide">Valgrind-Guide</a></p>
<hr/>
<h2 id="the-big-picture">The Big Picture<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#the-big-picture" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p><strong>Every malloc() involves:</strong></p>
<pre><code>Library:    Bins, free lists, coalescing
System:     Virtual memory, page tables
Kernel:     Buddy allocator, demand paging
Hardware:   DRAM, TLB, MMU
</code></pre>
<p><strong>Trade-offs:</strong></p>
<ul>
<li><strong>Speed vs fragmentation:</strong> Fast allocation → More fragmentation</li>
<li><strong>Memory efficiency vs performance:</strong> Coalescing → Slower</li>
<li><strong>Simplicity vs scalability:</strong> Global lock → Contention</li>
</ul>
<p><strong>This is systems programming.</strong> Memory management is at the heart of everything.</p>
<p><strong>Now you know WTF happens when you call <code>malloc()</code>.</strong></p></article><hr/><div class="page-footer"></div></div><div class="right sidebar"><div class="graph"><h3>Graph View</h3><div class="graph-outer"><div class="graph-container" data-cfg="{&quot;drag&quot;:true,&quot;zoom&quot;:true,&quot;depth&quot;:1,&quot;scale&quot;:1.1,&quot;repelForce&quot;:0.5,&quot;centerForce&quot;:0.3,&quot;linkDistance&quot;:30,&quot;fontSize&quot;:0.6,&quot;opacityScale&quot;:1,&quot;showTags&quot;:true,&quot;removeTags&quot;:[],&quot;focusOnHover&quot;:false,&quot;enableRadial&quot;:false}"></div><button class="global-graph-icon" aria-label="Global Graph"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 55 55" fill="currentColor" xml:space="preserve"><path d="M49,0c-3.309,0-6,2.691-6,6c0,1.035,0.263,2.009,0.726,2.86l-9.829,9.829C32.542,17.634,30.846,17,29,17
                s-3.542,0.634-4.898,1.688l-7.669-7.669C16.785,10.424,17,9.74,17,9c0-2.206-1.794-4-4-4S9,6.794,9,9s1.794,4,4,4
                c0.74,0,1.424-0.215,2.019-0.567l7.669,7.669C21.634,21.458,21,23.154,21,25s0.634,3.542,1.688,4.897L10.024,42.562
                C8.958,41.595,7.549,41,6,41c-3.309,0-6,2.691-6,6s2.691,6,6,6s6-2.691,6-6c0-1.035-0.263-2.009-0.726-2.86l12.829-12.829
                c1.106,0.86,2.44,1.436,3.898,1.619v10.16c-2.833,0.478-5,2.942-5,5.91c0,3.309,2.691,6,6,6s6-2.691,6-6c0-2.967-2.167-5.431-5-5.91
                v-10.16c1.458-0.183,2.792-0.759,3.898-1.619l7.669,7.669C41.215,39.576,41,40.26,41,41c0,2.206,1.794,4,4,4s4-1.794,4-4
                s-1.794-4-4-4c-0.74,0-1.424,0.215-2.019,0.567l-7.669-7.669C36.366,28.542,37,26.846,37,25s-0.634-3.542-1.688-4.897l9.665-9.665
                C46.042,11.405,47.451,12,49,12c3.309,0,6-2.691,6-6S52.309,0,49,0z M11,9c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2
                S11,10.103,11,9z M6,51c-2.206,0-4-1.794-4-4s1.794-4,4-4s4,1.794,4,4S8.206,51,6,51z M33,49c0,2.206-1.794,4-4,4s-4-1.794-4-4
                s1.794-4,4-4S33,46.794,33,49z M29,31c-3.309,0-6-2.691-6-6s2.691-6,6-6s6,2.691,6,6S32.309,31,29,31z M47,41c0,1.103-0.897,2-2,2
                s-2-0.897-2-2s0.897-2,2-2S47,39.897,47,41z M49,10c-2.206,0-4-1.794-4-4s1.794-4,4-4s4,1.794,4,4S51.206,10,49,10z"></path></svg></button></div><div class="global-graph-outer"><div class="global-graph-container" data-cfg="{&quot;drag&quot;:true,&quot;zoom&quot;:true,&quot;depth&quot;:-1,&quot;scale&quot;:0.9,&quot;repelForce&quot;:0.5,&quot;centerForce&quot;:0.2,&quot;linkDistance&quot;:30,&quot;fontSize&quot;:0.6,&quot;opacityScale&quot;:1,&quot;showTags&quot;:true,&quot;removeTags&quot;:[],&quot;focusOnHover&quot;:true,&quot;enableRadial&quot;:true}"></div></div></div><div class="toc desktop-only"><button type="button" class="toc-header" aria-controls="toc-115" aria-expanded="true"><h3>Table of Contents</h3><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="fold"><polyline points="6 9 12 15 18 9"></polyline></svg></button><ul id="list-1" class="toc-content overflow"><li class="depth-0"><a href="#wtf-happens-when-you-call-malloc" data-for="wtf-happens-when-you-call-malloc">WTF happens when you call malloc()</a></li><li class="depth-1"><a href="#table-of-contents" data-for="table-of-contents">Table of Contents</a></li><li class="depth-1"><a href="#1-you-call-malloc" data-for="1-you-call-malloc">1. You call malloc()</a></li><li class="depth-2"><a href="#your-c-code" data-for="your-c-code">Your C code</a></li><li class="depth-2"><a href="#what-malloc-is-not" data-for="what-malloc-is-not">What malloc() is NOT</a></li><li class="depth-1"><a href="#2-small-allocation--128kb" data-for="2-small-allocation--128kb">2. Small allocation (&lt; 128KB)</a></li><li class="depth-2"><a href="#heap-structure" data-for="heap-structure">Heap structure</a></li><li class="depth-2"><a href="#malloc-internal-structures-ptmalloc2" data-for="malloc-internal-structures-ptmalloc2">malloc() internal structures (ptmalloc2)</a></li><li class="depth-2"><a href="#size-classes-and-bins" data-for="size-classes-and-bins">Size classes and bins</a></li><li class="depth-2"><a href="#malloc1024-walkthrough" data-for="malloc1024-walkthrough">malloc(1024) walkthrough</a></li><li class="depth-2"><a href="#splitting-chunks" data-for="splitting-chunks">Splitting chunks</a></li><li class="depth-1"><a href="#3-large-allocation--128kb" data-for="3-large-allocation--128kb">3. Large allocation (≥ 128KB)</a></li><li class="depth-2"><a href="#malloc200000-using-mmap" data-for="malloc200000-using-mmap">malloc(200000) using mmap</a></li><li class="depth-2"><a href="#memory-layout-with-mmap-allocations" data-for="memory-layout-with-mmap-allocations">Memory layout with mmap allocations</a></li><li class="depth-1"><a href="#4-system-calls-brk-vs-mmap" data-for="4-system-calls-brk-vs-mmap">4. System calls: brk() vs mmap()</a></li><li class="depth-2"><a href="#brk--sbrk" data-for="brk--sbrk">brk() / sbrk()</a></li><li class="depth-2"><a href="#mmap" data-for="mmap">mmap()</a></li><li class="depth-1"><a href="#5-kernel-allocates-virtual-memory" data-for="5-kernel-allocates-virtual-memory">5. Kernel allocates virtual memory</a></li><li class="depth-2"><a href="#virtual-memory-area-vma" data-for="virtual-memory-area-vma">Virtual Memory Area (VMA)</a></li><li class="depth-2"><a href="#page-tables" data-for="page-tables">Page tables</a></li><li class="depth-1"><a href="#6-physical-memory-allocation-demand-paging" data-for="6-physical-memory-allocation-demand-paging">6. Physical memory allocation (demand paging)</a></li><li class="depth-2"><a href="#page-fault-flow" data-for="page-fault-flow">Page fault flow</a></li><li class="depth-2"><a href="#buddy-allocator-kernels-physical-memory-allocator" data-for="buddy-allocator-kernels-physical-memory-allocator">Buddy allocator (kernel’s physical memory allocator)</a></li><li class="depth-1"><a href="#7-you-write-to-the-memory" data-for="7-you-write-to-the-memory">7. You write to the memory</a></li><li class="depth-1"><a href="#8-you-call-free" data-for="8-you-call-free">8. You call free()</a></li><li class="depth-2"><a href="#small-allocation-heap" data-for="small-allocation-heap">Small allocation (heap)</a></li><li class="depth-2"><a href="#large-allocation-mmap" data-for="large-allocation-mmap">Large allocation (mmap)</a></li><li class="depth-1"><a href="#9-memory-allocator-internals" data-for="9-memory-allocator-internals">9. Memory allocator internals</a></li><li class="depth-2"><a href="#different-allocators" data-for="different-allocators">Different allocators</a></li><li class="depth-2"><a href="#multithreading-challenges" data-for="multithreading-challenges">Multithreading challenges</a></li><li class="depth-2"><a href="#fragmentation" data-for="fragmentation">Fragmentation</a></li><li class="depth-1"><a href="#10-complete-timeline" data-for="10-complete-timeline">10. Complete timeline</a></li><li class="depth-1"><a href="#key-takeaways" data-for="key-takeaways">Key takeaways</a></li><li class="depth-2"><a href="#memory-allocation-layers" data-for="memory-allocation-layers">Memory allocation layers</a></li><li class="depth-2"><a href="#fast-path-vs-slow-path" data-for="fast-path-vs-slow-path">Fast path vs slow path</a></li><li class="depth-2"><a href="#performance-tips" data-for="performance-tips">Performance tips</a></li><li class="depth-1"><a href="#related-concepts" data-for="related-concepts">Related concepts</a></li><li class="depth-1"><a href="#further-reading" data-for="further-reading">Further reading</a></li><li class="depth-1"><a href="#the-big-picture" data-for="the-big-picture">The Big Picture</a></li><li class="overflow-end"></li></ul></div></div><footer class><p>Created with <a href="https://quartz.jzhao.xyz/">Quartz v1.0.0</a> © 2025</p><ul><li><a href="https://github.com/tham-le">GitHub</a></li><li><a href="https://thamle.live">Portfolio</a></li></ul></footer></div></div></body><script type="application/javascript">function n(){let t=this.parentElement;t.classList.toggle("is-collapsed");let e=t.getElementsByClassName("callout-content")[0];if(!e)return;let l=t.classList.contains("is-collapsed");e.style.gridTemplateRows=l?"0fr":"1fr"}function c(){let t=document.getElementsByClassName("callout is-collapsible");for(let e of t){let l=e.getElementsByClassName("callout-title")[0],s=e.getElementsByClassName("callout-content")[0];if(!l||!s)continue;l.addEventListener("click",n),window.addCleanup(()=>l.removeEventListener("click",n));let o=e.classList.contains("is-collapsed");s.style.gridTemplateRows=o?"0fr":"1fr"}}document.addEventListener("nav",c);
</script><script type="module">function f(i,e){if(!i)return;function r(o){o.target===this&&(o.preventDefault(),o.stopPropagation(),e())}function t(o){o.key.startsWith("Esc")&&(o.preventDefault(),e())}i?.addEventListener("click",r),window.addCleanup(()=>i?.removeEventListener("click",r)),document.addEventListener("keydown",t),window.addCleanup(()=>document.removeEventListener("keydown",t))}function y(i){for(;i.firstChild;)i.removeChild(i.firstChild)}var h=class{constructor(e,r){this.container=e;this.content=r;this.setupEventListeners(),this.setupNavigationControls(),this.resetTransform()}isDragging=!1;startPan={x:0,y:0};currentPan={x:0,y:0};scale=1;MIN_SCALE=.5;MAX_SCALE=3;cleanups=[];setupEventListeners(){let e=this.onMouseDown.bind(this),r=this.onMouseMove.bind(this),t=this.onMouseUp.bind(this),o=this.resetTransform.bind(this);this.container.addEventListener("mousedown",e),document.addEventListener("mousemove",r),document.addEventListener("mouseup",t),window.addEventListener("resize",o),this.cleanups.push(()=>this.container.removeEventListener("mousedown",e),()=>document.removeEventListener("mousemove",r),()=>document.removeEventListener("mouseup",t),()=>window.removeEventListener("resize",o))}cleanup(){for(let e of this.cleanups)e()}setupNavigationControls(){let e=document.createElement("div");e.className="mermaid-controls";let r=this.createButton("+",()=>this.zoom(.1)),t=this.createButton("-",()=>this.zoom(-.1)),o=this.createButton("Reset",()=>this.resetTransform());e.appendChild(t),e.appendChild(o),e.appendChild(r),this.container.appendChild(e)}createButton(e,r){let t=document.createElement("button");return t.textContent=e,t.className="mermaid-control-button",t.addEventListener("click",r),window.addCleanup(()=>t.removeEventListener("click",r)),t}onMouseDown(e){e.button===0&&(this.isDragging=!0,this.startPan={x:e.clientX-this.currentPan.x,y:e.clientY-this.currentPan.y},this.container.style.cursor="grabbing")}onMouseMove(e){this.isDragging&&(e.preventDefault(),this.currentPan={x:e.clientX-this.startPan.x,y:e.clientY-this.startPan.y},this.updateTransform())}onMouseUp(){this.isDragging=!1,this.container.style.cursor="grab"}zoom(e){let r=Math.min(Math.max(this.scale+e,this.MIN_SCALE),this.MAX_SCALE),t=this.content.getBoundingClientRect(),o=t.width/2,n=t.height/2,c=r-this.scale;this.currentPan.x-=o*c,this.currentPan.y-=n*c,this.scale=r,this.updateTransform()}updateTransform(){this.content.style.transform=`translate(${this.currentPan.x}px, ${this.currentPan.y}px) scale(${this.scale})`}resetTransform(){this.scale=1;let e=this.content.querySelector("svg");this.currentPan={x:e.getBoundingClientRect().width/2,y:e.getBoundingClientRect().height/2},this.updateTransform()}},C=["--secondary","--tertiary","--gray","--light","--lightgray","--highlight","--dark","--darkgray","--codeFont"],E;document.addEventListener("nav",async()=>{let e=document.querySelector(".center").querySelectorAll("code.mermaid");if(e.length===0)return;E||=await import("https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.4.0/mermaid.esm.min.mjs");let r=E.default,t=new WeakMap;for(let n of e)t.set(n,n.innerText);async function o(){for(let s of e){s.removeAttribute("data-processed");let a=t.get(s);a&&(s.innerHTML=a)}let n=C.reduce((s,a)=>(s[a]=window.getComputedStyle(document.documentElement).getPropertyValue(a),s),{}),c=document.documentElement.getAttribute("saved-theme")==="dark";r.initialize({startOnLoad:!1,securityLevel:"loose",theme:c?"dark":"base",themeVariables:{fontFamily:n["--codeFont"],primaryColor:n["--light"],primaryTextColor:n["--darkgray"],primaryBorderColor:n["--tertiary"],lineColor:n["--darkgray"],secondaryColor:n["--secondary"],tertiaryColor:n["--tertiary"],clusterBkg:n["--light"],edgeLabelBackground:n["--highlight"]}}),await r.run({nodes:e})}await o(),document.addEventListener("themechange",o),window.addCleanup(()=>document.removeEventListener("themechange",o));for(let n=0;n<e.length;n++){let v=function(){let g=l.querySelector("#mermaid-space"),m=l.querySelector(".mermaid-content");if(!m)return;y(m);let w=c.querySelector("svg").cloneNode(!0);m.appendChild(w),l.classList.add("active"),g.style.cursor="grab",u=new h(g,m)},M=function(){l.classList.remove("active"),u?.cleanup(),u=null},c=e[n],s=c.parentElement,a=s.querySelector(".clipboard-button"),d=s.querySelector(".expand-button"),p=window.getComputedStyle(a),L=a.offsetWidth+parseFloat(p.marginLeft||"0")+parseFloat(p.marginRight||"0");d.style.right=`calc(${L}px + 0.3rem)`,s.prepend(d);let l=s.querySelector("#mermaid-container");if(!l)return;let u=null;d.addEventListener("click",v),f(l,M),window.addCleanup(()=>{u?.cleanup(),d.removeEventListener("click",v)})}});
</script><script src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/copy-tex.min.js" type="application/javascript"></script><script src="../postscript.js" type="module"></script></html>